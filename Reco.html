<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Free GST Reconciliation tool who reconcile your data within a seconds.
This GST Reconciliation Tool is designed to help you easily compare and match your GST data from GSTR-2B and GSTR-3B/books. This guide will walk you through the process step by step.

Step-by-Step Guide
Log in: Use your username and password to access the tool.
Download Sample File: Click on "Download Sample Excel File" to get a template for your data.
Prepare Your Data: Enter your GSTR-2B data in GST Portal sheet and GSTR-3B or books in client data sheet according to the sample file.
Upload File: Upload your prepared Excel file using the "Upload GST Data File" option.
Set Difference Allowed: Adjust the tolerance for differences in amounts (default is 1).
Enable Detailed Reconciliation: Check this box for detailed reconciliation or leave unchecked for a simple simple reconciliation.
Enable Filters (Optional): Use filters to sort or search through your data.
Reconcile Data: Click "Reconcile" to process and match your data.
Review Results: Check the GSTR-2B, GSTR-3B, and Summary tables for matched data.
Edit Data (If Needed): Make direct edits in the tables and reconcile again.
Download Output: Click "Download Reconciled Data" to save the results.
Feature Descriptions
Login System: Secure access with username and password. Subscription status is verified upon login.
Sample File Download: Provides a template to ensure your data is correctly formatted.
File Upload: Upload your GST data in Excel (.xlsx) format.
Difference Allowed: Set the acceptable difference in taxable value, IGST, CGST, and SGST for matching (default: 1).
Detailed Reconciliation: When enabled, shows detailed match criteria; when disabled, shows a simplified "Match" or "Unmatch".
Enable Filters: Adds dropdown filters to table columns for easy data sorting and searching.
Reconcile Button: Processes the data and updates the tables with match results.
Reset Data Button: Clears all uploaded data and resets the tool.
Editable Tables: Directly edit data in the tables; changes are reflected upon reconciling again.
Download Reconciled Data: Generates an Excel file with matched data, including color-coded rows for clarity.
Understanding Match Criteria
When Detailed Reconciliation is enabled, the tool uses the following criteria:

Match - GSTN, Invoice No., Date: Exact match on GSTN, invoice number, and date.
Match - GSTN, Invoice No.: Match on GSTN and invoice number, with possible date differences.
Match - GSTN, Date: Match on GSTN and date, with possible invoice number differences.
Match - GSTN: Match only on GSTN, with differences in invoice number and date.
Unmatch - GSTN Not Exist: GSTN from one sheet is not found in the other.
Unmatch - Amt Diff: Showing unmatch invoices due to amt difference
Unmatch: Data does not meet any match criteria, generally due to extra invoices in either GSTR-2B or GSTR-3B/Books
When Detailed Reconciliation is disabled, the criteria are simplified:

Match: Data matches based on any of the detailed criteria above.
Unmatch - GSTN Not Exist: GSTN from one sheet is not found in the other.
Unmatch - Amt Diff: Showing unmatch invoices due to amt difference
Unmatch: Data does not meet any match criteria, generally due to extra invoices in either GSTR-2B or GSTR-3B/Books">
    <meta name="keywords" content="GST,GST Reco, Reconciliation, GST Reconciliation, GSTR-2B, GSTR2B, GSTR-3B, GSTR3B, 2b vs 3b, gst.gov.in, https://www.gst.gov.in/, GST Login">
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">
    <meta property="og:title" content="GST Reconciliation">
    <meta property="og:image" content="https://sumitgarg100000.github.io/GSTReconciliation/Image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="GST Reconciliation Preview">
    <meta name="google-site-verification" content="FR7D2qkpciz6QmllRnOJ7Mv6bbsFJ1CA6Qn7mYDkqwE" />
    <title>GST Reconciliation Tool - Professional Edition</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css">
 <style>
     
  /* styles.css */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', 'Segoe UI', Arial, sans-serif;
}

:root {
    --primary-color: #1a73e8;
    --primary-dark: #0d47a1;
    --text-primary: #333333;
    --text-secondary: #666666;
    --bg-gradient-1: linear-gradient(135deg, #f5f7fa, #e4f1ff);
}

body {
    background: var(--bg-gradient-1);
    color: var(--text-primary);
    padding: 20px;
    line-height: 1.6;
}

/* Container */
.container {
    max-width: 100%;
    width: 98%;
    margin: 0 auto;
    background: #fff;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0, 61, 115, 0.1);
    min-height: calc(80vh - 40px);
    display: flex;
    flex-direction: column;
    position: relative;
}

.container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 8px;
    background: linear-gradient(135deg, #1a73e8, #0d47a1);
}

/* Instructions Container (Styled to match explanation section) */
.instructions-container {
    margin-top: 20px;
    padding: 20px;
    background-color: #f5f9ff;
    border: 1px solid #cce0ff;
    border-radius: 8px;
    overflow-y: auto;
    max-height: calc(100vh - 300px);
}

.instructions-container h2, .instructions-container h3 {
    color: #0e4377;
    background: none;
    text-align: left;
    padding: 0;
    margin-bottom: 15px;
}

.instructions-container ul, .instructions-container ol {
    margin-left: 20px;
    margin-bottom: 15px;
}

.instructions-container li {
    margin-bottom: 5px;
    color: #333;
}

.instructions-container p {
    line-height: 1.6;
    color: #333;
    margin-bottom: 15px;
}

/* WhatsApp Button */
.whatsapp-btn {
    position: fixed;
    z-index: 1000;
    bottom: 20px;
    right: 20px;
    background: linear-gradient(145deg, #25d366, #128C7E);
    color: white;
    width: 70px;
    height: 70px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    box-shadow: 0 0 20px 10px rgba(37, 211, 102, 0.1);
    animation: glow 3s infinite;
    transition: all 0.3s ease;
}

.whatsapp-btn:hover {
    transform: scale(1.1);
    animation-play-state: paused;
}

.whatsapp-btn i {
    font-size: 36px;
}

/* Footer */
footer {
    background: linear-gradient(145deg, #0e4377, #1a5fb4);
    color: #ffffff;
    padding: 1.5rem;
    border-radius: 10px;
    margin-top: 30px;
    box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05);
}

.footer-content {
    max-width: 1200px;
    margin: 0 auto;
    text-align: center;
}

.footer-links {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin: 1rem 0;
    flex-wrap: wrap;
}

.footer-links a {
    color: #ffffff;
    text-decoration: none;
    opacity: 0.9;
    transition: opacity 0.3s ease;
    padding: 5px 10px;
    border-radius: 5px;
}

.footer-links a:hover {
    opacity: 1;
    text-decoration: underline;
    background: rgba(255, 255, 255, 0.1);
}

/* Animation for WhatsApp Button Glow */
@keyframes glow {
    0% { box-shadow: 0 0 20px 0px rgba(26, 115, 232, 0.2); transform: scale(1); }
    50% { box-shadow: 0 0 40px 20px rgba(26, 115, 232, 0.1); transform: scale(1.05); }
    100% { box-shadow: 0 0 20px 0px rgba(26, 115, 232, 0.2); transform: scale(1); }
}

/* Header Navigation */
.header-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding: 10px 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.logo {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--primary-dark);
    text-decoration: none;
    display: flex;
    align-items: center;
}

.logo i {
    margin-right: 10px;
    color: var(--primary-color);
}

.nav-links {
    display: flex;
}

.nav-links a {
    margin-left: 25px;
    color: var(--text-secondary);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    position: relative;
}

.nav-links a:hover {
    color: var(--primary-color);
}

.nav-links a::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 0;
    width: 0;
    height: 2px;
    background: var(--primary-color);
    transition: width 0.3s ease;
}

.nav-links a:hover::after {
    width: 100%;
}

.mobile-menu-btn {
    display: none;
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--primary-dark);
    cursor: pointer;
}

/* Login Section */
#login-section {
    display: flex;
    flex-direction: column;
    height: 100%;
}

h1 {
    text-align: center;
    color: #0e4377;
    font-size: 2.5em;
    margin-bottom: 20px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
}

h2 {
    text-align: center;
    color: #1a5fb4;
    font-size: 1.8em;
    margin: 20px 0;
    padding: 10px;
    background: linear-gradient(to right, #e6f3ff, #f0f8ff);
    border-radius: 8px;
}

/* Control Panel */
.control-panel {
    background: #f5f9ff;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0 4px 10px rgba(0, 61, 115, 0.05);
}

/* Options Container */
.options-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 20px;
    padding: 15px;
    background: #e6f3ff;
    border-radius: 10px;
    border: 1px solid #cce0ff;
}

.option-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Button Container */
.button-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    margin: 20px 0;
}

button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 25px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.1em;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

button:active {
    transform: translateY(1px);
}

#reconcile-btn {
    background: linear-gradient(145deg, #1a73e8, #0d47a1);
    color: white;
}

#reconcile-btn:hover {
    background: linear-gradient(145deg, #0d47a1, #1a73e8);
}

#reset-btn {
    background: linear-gradient(145deg, #e53935, #c62828);
    color: white;
}

#reset-btn:hover {
    background: linear-gradient(145deg, #c62828, #e53935);
}

#download-sample {
    background: linear-gradient(145deg, #2e7d32, #1b5e20);
    color: white;
}

#download-sample:hover {
    background: linear-gradient(145deg, #1b5e20, #2e7d32);
}

/* Upload Section */
.upload-section {
    background: #f0f8ff;
    padding: 15px;
    border-radius: 10px;
    border: 1px dashed #1a73e8;
    margin: 20px 0;
    transition: all 0.3s ease;
}

.upload-section:hover {
    background: #e6f3ff;
    border-color: #0d47a1;
}

input[type="file"] {
    padding: 10px;
    border: 2px solid #1a73e8;
    border-radius: 8px;
    background: #f5f9ff;
    width: 100%;
    transition: border-color 0.3s;
}

input[type="file"]:hover {
    border-color: #0d47a1;
}

input[type="number"], input[type="checkbox"], input[type="text"], input[type="password"] {
    padding: 10px;
    border: 2px solid #1a73e8;
    border-radius: 8px;
    background: #f5f9ff;
    transition: all 0.3s ease;
}

input[type="number"]:focus, input[type="text"]:focus, input[type="password"]:focus {
    border-color: #0d47a1;
    outline: none;
    box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
}

/* Checkbox Group */
.checkbox-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #1a73e8;
}

label {
    font-weight: 600;
    color: #0e4377;
}

/* Data Container */
.data-container {
    margin: 30px 0;
}

/* Table Container */
.table-container {
    overflow-x: auto;
    overflow-y: auto;
    max-height: 800px;
    margin: 15px 0;
    border: 1px solid #cce0ff;
    border-radius: 8px;
    padding: 5px;
    background: #f5f9ff;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

table thead th {
    position: sticky;
    top: 0;
    background: #1a73e8;
    color: white;
    z-index: 10;
    border-bottom: 1px solid #0d47a1;
    padding: 12px;
    text-align: left;
}

th {
    background: #1a73e8;
    color: white;
    font-weight: bold;
    padding: 12px;
    text-align: left;
}

td {
    border: 1px solid #cce0ff;
    padding: 10px;
    text-align: left;
}

/* Tool and Login Section */
#tool-section {
    transition: all 0.5s ease;
}

#login-section.hidden, #tool-section.hidden {
    display: none;
}

/* Error and Expiry Messages */
#error {
    color: #e53935;
    text-align: center;
    margin-top: 10px;
    font-weight: 600;
}

#expiry-message {
    font-size: 1.2em;
    margin: 10px 0;
    padding: 10px;
    background: #ffebee;
    border-left: 4px solid #e53935;
    border-radius: 4px;
    transition: opacity 0.5s ease;
    color: #e53935;
}

/* Download Output Link */
a#download-output {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 25px;
    background: linear-gradient(145deg, #1a73e8, #0d47a1);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.1em;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    text-decoration: none;
    margin: 20px auto;
    text-align: center;
}

a#download-output:hover {
    background: linear-gradient(145deg, #0d47a1, #1a73e8);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

/* Filter Dropdown */
.filter-dropdown {
    position: relative;
    display: inline-block;
}

.filter-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    color: white;
    padding: 0;
    margin-left: 5px;
    box-shadow: none;
}

.filter-dropdown-content {
    display: none;
    position: absolute;
    background-color: #fff;
    min-width: 200px;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #cce0ff;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    z-index: 20;
    font-family: 'Segoe UI', Arial, sans-serif;
}

.filter-dropdown-content.show {
    display: block;
}

.filter-input {
    width: 100%;
    padding: 8px;
    border: 1px solid #cce0ff;
    border-radius: 4px;
    margin-bottom: 5px;
    font-size: 14px;
    font-weight: 400;
}

.filter-option {
    padding: 8px 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 400;
    color: #333;
}

.filter-option:hover {
    background-color: #f0f8ff;
}

.filter-option input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: #1a73e8;
}

.filter-option label {
    font-weight: 400;
    color: #333;
}

.filter-actions {
    padding: 8px;
    border-top: 1px solid #cce0ff;
    display: flex;
    justify-content: space-between;
}

.filter-actions button {
    background: #1a73e8;
    color: white;
    border: none;
    padding: 5px 10px;
    margin: 0 2px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: background 0.3s ease;
}

.filter-actions button:hover {
    background: #0d47a1;
    transform: none;
}

.sort-actions {
    padding: 8px;
    border-top: 1px solid #cce0ff;
    display: flex;
    justify-content: space-between;
}

.sort-actions button {
    background: #1a73e8;
    color: white;
    border: none;
    padding: 5px 10px;
    margin: 0 2px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: background 0.3s ease;
}

.sort-actions button:hover {
    background: #0d47a1;
    transform: none;
}

/* Custom Select */
.custom-select {
    position: relative;
    display: inline-block;
    min-width: 150px;
    margin: 0 10px;
}

.custom-select select {
    appearance: none;
    -webkit-appearance: none;
    width: 100%;
    padding: 10px 15px;
    border: 2px solid #1a73e8;
    border-radius: 8px;
    background-color: #f5f9ff;
    color: #0e4377;
    font-weight: 600;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.custom-select select:hover {
    border-color: #0d47a1;
    background-color: #e6f3ff;
}

.custom-select select:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
}

.custom-select::after {
    content: "\25BC";
    position: absolute;
    top: 50%;
    right: 15px;
    transform: translateY(-50%);
    color: #1a73e8;
    pointer-events: none;
}

/* Progress Bar */
.progress-container {
    margin: 20px 0;
    padding: 15px;
    background: #f0f8ff;
    border-radius: 10px;
    border: 1px solid #cce0ff;
    display: none;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background-color: #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #1a73e8, #0d47a1);
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 10px;
}

.progress-text {
    text-align: center;
    font-weight: 600;
    color: #0e4377;
    margin: 5px 0;
}

/* Memory Option */
.memory-option {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
}

.memory-option label {
    color: #856404;
    font-weight: 600;
}

.memory-option .description {
    font-size: 0.9em;
    color: #856404;
    margin-top: 5px;
}

/* Explanation Section */
.explanation {
    margin-top: 20px;
    padding: 20px;
    background-color: #f5f9ff;
    border: 1px solid #cce0ff;
    border-radius: 8px;
    overflow-y: auto;
    max-height: calc(100vh - 300px);
}

.explanation h2, .explanation h3 {
    color: #0e4377;
    background: none;
    text-align: left;
    padding: 0;
}

.explanation ul, .explanation ol {
    margin-left: 20px;
    margin-bottom: 15px;
}

.explanation li {
    margin-bottom: 5px;
}

.youtube-link {
    color: #1a73e8;
    text-decoration: none;
    font-weight: 600;
}

.youtube-link:hover {
    text-decoration: underline;
}

.progress-text {
    text-align: center;
    font-weight: 600;
    color: #0e4377;
    margin: 5px 0;
    white-space: nowrap; /* Prevent text wrapping */
}
      
/* Responsive Styles */
@media (max-width: 768px) {
    .container {
        padding: 20px;
        width: 100%;
        min-height: calc(100vh - 60px);
        padding: 15px;
    }

    .nav-links {
        display: none;
    }

    .mobile-menu-btn {
        display: block;
    }

    .mobile-menu-open .nav-links {
        display: flex;
        flex-direction: column;
        position: absolute;
        top: 70px;
        right: 20px;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        z-index: 100;
    }

    .mobile-menu-open .nav-links a {
        margin: 10px 0;
    }

    .options-container {
        flex-direction: column;
    }

    .button-container {
        flex-direction: column;
    }

    button {
        width: 100%;
    }

    h1 {
        font-size: 2em;
    }

    .custom-select {
        width: 100%;
        margin: 10px 0;
    }

    .footer-links {
        flex-direction: column;
        gap: 10px;
    }
}

@media (max-width: 480px) {
    .container {
        padding: 15px;
    }
}   
     
 </style>
</head>
<body>
    <div class="container">
        <header class="header-nav">
            <a href="#" class="logo">
                <i class="fas fa-chart-line"></i>
                <span>Sumit Garg</span>
            </a>
            <div class="nav-links">
                <a href="#">Home</a>
                <a href="#">Services</a>
                <a href="#">About</a>
                <a href="#">Contact</a>
            </div>
            <button class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
        </header>

        <!-- Login Section -->
        <div id="login-section">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold">GST Reconciliation Login</h1>
                <button onclick="goToHomepage()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                    <i class="fas fa-home"></i> Back to Homepage
                </button>
            </div>
            
            <div class="mb-6">
                <label for="username" class="block mb-2">Username:</label>
                <input type="text" id="username" value="" placeholder="Enter username" class="w-full">
            </div>
            <div class="mb-6">
                <label for="password" class="block mb-2">Password:</label>
                <input type="password" id="password" value="" placeholder="Enter password" class="w-full">
            </div>
            <div class="flex flex-wrap justify-center gap-4">
                <button onclick="login()" style="background: linear-gradient(145deg, #1a73e8, #0d47a1); color: white;" class="flex-1">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <button onclick="freeServiceLogin()" style="background: linear-gradient(145deg, #ff9800, #f57c00); color: white;" class="flex-1">
                    <i class="fas fa-user-check"></i> Free Service Login
                </button>
            </div>
            <p id="error" class="mt-4"></p>

          <div class="explanation" id="explanation-container">
            <h2 class="text-xl font-bold mb-4">How to Use the GST Reconciliation Tool</h2>
            <p class="mb-4">The GST Reconciliation Tool is designed to help you easily compare and match your GST data from GSTR-2B and GSTR-3B. This guide will walk you through the process step by step.</p>
            
            <h3 class="text-lg font-bold mb-2">Watch Tutorial Video</h3>
            <p class="mb-4">Check out our step-by-step tutorial video on YouTube to learn how to use the GST Reconciliation Tool effectively:</p>
            <p class="mb-6"><a href="https://youtu.be/pTR1yrEHlrU" class="youtube-link" target="_blank" rel="noopener noreferrer">Click Here</a></p>
            
            <h3 class="text-lg font-bold mb-2">Step-by-Step Guide</h3>
            <ol class="list-decimal ml-6 mb-6">
              <li><strong>Log in</strong>: Use your username and password to access the tool.</li>
              <li><strong>Download Sample File</strong>: Click on "Download Sample Excel File" to get a template for your data.</li>
              <li><strong>Prepare Your Data</strong>: Enter your GSTR-2B data in GST Portal sheet and GSTR-3B or books in client data sheet according to the sample file.</li>
              <li><strong>Upload File</strong>: Upload your prepared Excel file using the "Upload GST Data File" option.</li>
              <li><strong>Set Difference Allowed</strong>: Adjust the tolerance for differences in amounts (default is 1).</li>
              <li><strong>Enable Detailed Reconciliation</strong>: Check this box for detailed reconciliation or leave unchecked for a simple reconciliation.</li>
              <li><strong>Enable Filters (Optional)</strong>: Use filters to sort or search through your data.</li>
              <li><strong>Reconcile Data</strong>: Click "Reconcile" to process and match your data.</li>
              <li><strong>Review Results</strong>: Check the GSTR-2B, GSTR-3B, and Summary tables for matched data.</li>
              <li><strong>Edit Data (If Needed)</strong>: Make direct edits in the tables and reconcile again.</li>
              <li><strong>Download Output</strong>: Click "Download Reconciled Data" to save the results.</li>
            </ol>
            
            <h3 class="text-lg font-bold mb-2">Feature Descriptions</h3>
            <ul class="list-disc ml-6 mb-6">
              <li><strong>Login System</strong>: Secure access with username and password. Subscription status is verified upon login.</li>
              <li><strong>Sample File Download</strong>: Provides a template to ensure your data is correctly formatted.</li>
              <li><strong>File Upload</strong>: Upload your GST data in Excel (.xlsx) format.</li>
              <li><strong>Difference Allowed</strong>: Set the acceptable difference in taxable value, IGST, CGST, and SGST for matching (default: 1).</li>
              <li><strong>Detailed Reconciliation</strong>: When enabled, shows detailed match criteria; when disabled, shows a simplified "Match" or "Unmatch".</li>
              <li><strong>Enable Filters</strong>: Adds dropdown filters to table columns for easy data sorting and searching.</li>
              <li><strong>Reconcile Button</strong>: Processes the data and updates the tables with match results.</li>
              <li><strong>Reset Data Button</strong>: Clears all uploaded data and resets the tool.</li>
              <li><strong>Editable Tables</strong>: Directly edit data in the tables; changes are reflected upon reconciling again.</li>
              <li><strong>Download Reconciled Data</strong>: Generates an Excel file with matched data, including color-coded rows for clarity.</li>
            </ul>
            
            <h3 class="text-lg font-bold mb-2">Understanding Match Criteria</h3>
            <p class="mb-2">When <strong>Detailed Reconciliation</strong> is enabled, the tool uses the following criteria:</p>
            <ul class="list-disc ml-6 mb-4">
              <li><strong>Match - GSTN, Invoice No., Date</strong>: Exact match on GSTN, invoice number, and date.</li>
              <li><strong>Match - GSTN, Invoice No.</strong>: Match on GSTN and invoice number, with possible date differences.</li>
              <li><strong>Match - GSTN, Date</strong>: Match on GSTN and date, with possible invoice number differences.</li>
              <li><strong>Match - GSTN</strong>: Match only on GSTN, with differences in invoice number and date.</li>
              <li><strong>Unmatch - GSTN Not Exist</strong>: GSTN from one sheet is not found in the other.</li>
              <li><strong>Unmatch - Amt Diff</strong>: GSTN and Invoice Number match, but amounts (Taxable Value, IGST, CGST, SGST) differ by more than the allowed difference.</li>
              <li><strong>Unmatch</strong>: Data does not meet any match criteria, generally due to extra invoices in either GSTR-2B or GSTR-3B/Books</li>
            </ul>
            <p class="mb-2">When <strong>Detailed Reconciliation</strong> is disabled, the criteria are simplified:</p>
            <ul class="list-disc ml-6 mb-4">
              <li><strong>Match</strong>: Data matches based on any of the detailed criteria above.</li>
              <li><strong>Unmatch - GSTN Not Exist</strong>: GSTN from one sheet is not found in the other.</li>
              <li><strong>Unmatch - Amt Diff</strong>: GSTN and Invoice Number match, but amounts (Taxable Value, IGST, CGST, SGST) differ by more than the allowed difference.</li>
              <li><strong>Unmatch</strong>: Data does not meet any match criteria, generally due to extra invoices in either GSTR-2B or GSTR-3B/Books</li>
            </ul>
          </div>
        
        </div>

        <!-- Tool Section -->
        <div id="tool-section" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h1>GST Reconciliation Tool</h1>
                <button onclick="logout()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
            <p id="expiry-message" style="display: none;" class="text-center"></p>
            
            <div class="control-panel">
                <!-- Sample Download Button -->
                <div class="button-container">
                    <button id="download-sample" class="bg-green-600 hover:bg-green-700">
                        <i class="fas fa-file-download"></i> Download Sample Excel File
                    </button>
                </div>
                
                <!-- Options Container -->
                <div class="options-container">
                    <div class="option-group">
                        <label for="diff-allowed">Difference Allowed:</label>
                        <input type="number" id="diff-allowed" value="1" min="0" class="w-20" placeholder="0 if blank">
                        <span class="text-sm text-gray-600">(Default: 1)</span>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="detailed-reconciliation" name="detailed-reconciliation">
                        <label for="detailed-reconciliation">Detailed Reconciliation</label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="enable-filter" name="enable-filter">
                        <label for="enable-filter">Enable Filters</label>
                    </div>
                </div>

                <!-- Memory Management Option -->
                <div class="memory-option">
                    <div class="checkbox-group">
                        <input type="checkbox" id="memory-storage" name="memory-storage" checked>
                        <label for="memory-storage">Enable Memory Storage</label>
                    </div>
                    <div class="description">
                        Keep this enabled for normal operations. Uncheck for very large datasets to save memory.
                    </div>
                </div>
                
                <!-- Upload Section -->
                <div class="upload-section">
                    <label for="gst-file" class="block mb-2">
                        <i class="fas fa-file-upload mr-2"></i>Upload GST Data File (GSTR-2B & GSTR-3B):
                    </label>
                    <input type="file" id="gst-file" accept=".xlsx" class="block w-full">
                </div>
                
                <!-- Progress Container -->
                <div id="progress-container" class="progress-container">
                    <div class="progress-text" id="progress-text">Processing...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text" id="progress-percentage">0%</div>
                </div>
                
                <!-- Action Buttons -->
                <div class="button-container">
                    <button id="reconcile-btn">
                        <i class="fas fa-sync-alt"></i> Reconcile
                    </button>
                    <button id="reset-btn">
                        <i class="fas fa-trash-alt"></i> Reset Data
                    </button>
                </div>
            </div>
            
            <div class="data-container">
                <h2>GSTR-2B Data</h2>
                <div id="gstr2b-container" class="table-container"></div>
                
                <h2>Client Data</h2>
                <div id="gstr3b-container" class="table-container"></div>
                
                <h2>Summary</h2>
                <div id="summary-container" class="table-container"></div>
            </div>
            
            <div id="output-link" style="display: none;" class="text-center">
                <h3 class="text-xl font-bold text-blue-800 mb-4">Reconciled Output:</h3>
                <a id="download-output" href="#" class="inline-block">
                    <i class="fas fa-file-excel mr-2"></i> Download Reconciled Data
                </a>
            </div>
        </div>
    </div>
    
        <a href="https://wa.me/9716804520" class="whatsapp-btn" target="_blank" rel="noopener noreferrer" aria-label="Chat on WhatsApp">
      <i class="fab fa-whatsapp"></i>
    </a>

 <footer>
      <div class="footer-content">
        <div class="footer-links">
          <a href="#"><i class="fas fa-phone mr-2"></i> Ph: 9716804520</a>
          <a href="#"><i class="fas fa-envelope mr-2"></i> Email: Sumitgarg100000@gmail.com</a>
          <a href="#"><i class="fas fa-map-marker-alt mr-2"></i> Address: Rohini, Delhi-110086</a>
        </div>
        <div class="footer-links">
          <a href="#">Privacy Policy</a>
          <a href="#">Terms of Service</a>
        </div>
      </div>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.29.3/date-fns.min.js"></script>

    <script>
        
       
    //     if (window.location.href.toLowerCase(). includes("https://sumitgarg100000.github.io")) {
       
        
        const users = {
            "Sumitgarg": { password: "Garg@123", expiry: "2026-04-30" },
            "user1": { password: "pass123", expiry: "2025-06-30" },
            "user2": { password: "pass456", expiry: "2025-05-15" }
        };

        let gstr2bData = [];
        let gstr3bData = [];
        let isProcessing = false;
        const detailedReconciliationCheckbox = document.getElementById('detailed-reconciliation');
        const CHUNK_SIZE = 100; // Process data in chunks of 100 rows

        // Memory management
        function shouldUseMemoryStorage() {
            return document.getElementById('memory-storage').checked;
        }

        function getStoredData(key) {
            if (!shouldUseMemoryStorage()) return null;
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.warn('Error reading from localStorage:', e);
                return null;
            }
        }

        function setStoredData(key, data) {
            if (!shouldUseMemoryStorage()) return;
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.warn('Error writing to localStorage:', e);
            }
        }

        function removeStoredData(key) {
            try {
                localStorage.removeItem(key);
            } catch (e) {
                console.warn('Error removing from localStorage:', e);
            }
        }

        // Progress indicator functions
        function showProgress() {
            document.getElementById('progress-container').style.display = 'block';
        }

        function hideProgress() {
            document.getElementById('progress-container').style.display = 'none';
        }

        function updateProgress(percentage, text) {
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-percentage').textContent = Math.round(percentage) + '%';
            if (text) {
                document.getElementById('progress-text').textContent = text;
            }
        }

        // Chunked processing function
        async function processInChunks(data, processFn, chunkSize = CHUNK_SIZE) {
    const results = [];
    const totalChunks = Math.ceil(data.length / chunkSize);
    let startTime = performance.now();
    
    for (let i = 0; i < totalChunks; i++) {
        const chunkStartTime = performance.now();
        const start = i * chunkSize;
        const end = Math.min(start + chunkSize, data.length);
        const chunk = data.slice(start, end);
        
        const chunkResults = await processFn(chunk, i);
        results.push(...chunkResults);
        
        const chunkEndTime = performance.now();
        const chunkTime = chunkEndTime - chunkStartTime;
        const elapsedTime = chunkEndTime - startTime;
        const remainingChunks = totalChunks - (i + 1);
        const estimatedRemainingTime = remainingChunks * chunkTime / 1000; // in seconds
        
        const progress = ((i + 1) / totalChunks) * 100;
        updateProgress(progress, `Processing chunk ${i + 1} of ${totalChunks} | Est. time remaining: ${estimatedRemainingTime.toFixed(1)}s`);
        
        // Allow UI to update
        await new Promise(resolve => setTimeout(resolve, 10));
    }
    
    return results;
}

        // Page load check
        document.addEventListener("DOMContentLoaded", function() {
            const loggedInUser = getStoredData("loggedInUser") || localStorage.getItem("loggedInUser");
            const isFreeService = getStoredData("isFreeService") === "true" || localStorage.getItem("isFreeService") === "true";

            if (loggedInUser) {
                if (isFreeService) {
                    showTool();
                    restrictFreeServiceFeatures();
                } else if (checkSubscription(loggedInUser)) {
                    showTool();
                } else {
                    showLogin();
                }
            } else {
                showLogin();
            }
        });

        function login() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const error = document.getElementById("error");

            if (users[username] && users[username].password === password) {
                if (checkSubscription(username)) {
                    setStoredData("loggedInUser", username);
                    setStoredData("isFreeService", "false");
                    showTool();

                    const expiryMessage = document.getElementById("expiry-message");
                    if (expiryMessage) {
                        expiryMessage.textContent = `Subscription Expiry: ${users[username].expiry}`;
                        expiryMessage.style.display = "block";
                        expiryMessage.style.opacity = "1";

                        setTimeout(() => {
                            expiryMessage.style.opacity = "0";
                            setTimeout(() => {
                                expiryMessage.style.display = "none";
                                expiryMessage.style.opacity = "1";
                            }, 500);
                        }, 10000);
                    }

                    document.getElementById("username").value = "";
                    document.getElementById("password").value = "";
                    error.textContent = "";
                } else {
                    error.textContent = "Your subscription has expired!";
                }
            } else {
                error.textContent = "Invalid username or password!";
            }
        }

        function freeServiceLogin() {
            setStoredData("loggedInUser", "freeServiceUser");
            setStoredData("isFreeService", "true");
            showTool();
            restrictFreeServiceFeatures();
            document.getElementById("username").value = "";
            document.getElementById("password").value = "";
            document.getElementById("error").textContent = "";
        }

        function checkSubscription(username) {
            const expiryDate = new Date(users[username].expiry);
            const today = new Date();
            return today <= expiryDate;
        }

        function logout() {
            removeStoredData("loggedInUser");
            removeStoredData("gstr2bData");
            removeStoredData("gstr3bData");
            removeStoredData("isFreeService");
            gstr2bData = [];
            gstr3bData = [];
            resetData();
            showLogin();
            document.getElementById("username").value = "";
            document.getElementById("password").value = "";
            document.getElementById("error").textContent = "";
        }

        function goToHomepage() {
            window.location.href = 'https://sumitgarg100000.github.io/Home/';
        }

        function showLogin() {
            document.getElementById("login-section").classList.remove("hidden");
            document.getElementById("tool-section").classList.add("hidden");
        }

        function showTool() {
            document.getElementById("login-section").classList.add("hidden");
            document.getElementById("tool-section").classList.remove("hidden");

            const isFreeService = getStoredData("isFreeService") === "true" || localStorage.getItem("isFreeService") === "true";

            const detailedReconciliationCheckbox = document.getElementById("detailed-reconciliation");
            detailedReconciliationCheckbox.checked = getStoredData('detailedReconciliation') === 'true' && !isFreeService;

            const reconcileBtn = document.getElementById('reconcile-btn');
            const downloadSample = document.getElementById('download-sample');
            const diffAllowed = document.getElementById('diff-allowed');
            diffAllowed.value = "1";
            const resetBtn = document.getElementById('reset-btn');
            const gstFile = document.getElementById('gst-file');

            // Remove existing event listeners
            reconcileBtn.removeEventListener('click', reconcileData);
            downloadSample.removeEventListener('click', generateSampleFile);
            diffAllowed.removeEventListener('input', reconcileData);
            resetBtn.removeEventListener('click', resetData);
            gstFile.removeEventListener('change', handleFileUpload);

            // Add event listeners
            gstFile.addEventListener('change', handleFileUpload);
            reconcileBtn.addEventListener('click', reconcileData);
            downloadSample.addEventListener('click', generateSampleFile);
            diffAllowed.addEventListener('input', debounce(reconcileData, 500));
            resetBtn.addEventListener('click', resetData);

            detailedReconciliationCheckbox.removeEventListener('change', handleCheckboxChange);
            detailedReconciliationCheckbox.addEventListener('change', handleCheckboxChange);

            function handleCheckboxChange() {
                reconcileData();
                setStoredData('detailedReconciliation', detailedReconciliationCheckbox.checked);
            }

            // Restore previous data
            const stored2bData = getStoredData('gstr2bData');
            const stored3bData = getStoredData('gstr3bData');
            
            if (stored2bData && stored2bData.length > 0) {
                gstr2bData = stored2bData;
                displayData(gstr2bData, 'gstr2b-container', gstr2bHeaders(), 'gstr2b');
            }
            if (stored3bData && stored3bData.length > 0) {
                gstr3bData = stored3bData;
                displayData(gstr3bData, 'gstr3b-container', gstr3bHeaders(), 'gstr3b');
            }
            if (gstr2bData.length > 0 || gstr3bData.length > 0) {
                reconcileData();
            }

            const filterCheckbox = document.getElementById("enable-filter");
            if (!isFreeService) {
                detailedReconciliationCheckbox.disabled = false;
                filterCheckbox.disabled = false;
                diffAllowed.disabled = false;
                document.getElementById("free-service-notice")?.remove();
            }
            restrictFreeServiceFeatures();
        }

        function restrictFreeServiceFeatures() {
            const isFreeService = getStoredData("isFreeService") === "true" || localStorage.getItem("isFreeService") === "true";

            if (isFreeService) {
                const detailedCheckbox = document.getElementById("detailed-reconciliation");
                detailedCheckbox.checked = false;
                detailedCheckbox.disabled = true;

                const filterCheckbox = document.getElementById("enable-filter");
                filterCheckbox.checked = false;
                filterCheckbox.disabled = true;
                filterEnabled = false;
                toggleFilters();

                const diffAllowedInput = document.getElementById("diff-allowed");
                diffAllowedInput.value = "1";
                diffAllowedInput.disabled = true;

                const tables = document.querySelectorAll("#gstr2b-container table, #gstr3b-container table");
                tables.forEach(table => {
                    const rows = table.querySelectorAll("tbody tr");
                    rows.forEach(row => {
                        const cells = row.querySelectorAll("td");
                        cells.forEach(cell => {
                            cell.setAttribute("contenteditable", "false");
                        });
                    });
                });

                applyFreeServiceColors();

                const toolSection = document.getElementById("tool-section");
                const notice = document.createElement("p");
                notice.id = "free-service-notice";
                notice.style.color = "#e53935";
                notice.style.textAlign = "center";
                notice.style.padding = "10px";
                notice.style.margin = "10px 0";
                notice.style.backgroundColor = "#ffebee";
                notice.style.borderRadius = "8px";
                notice.style.borderLeft = "4px solid #e53935";
                notice.textContent = "In Free Service: Detailed Reconciliation feature, Enable Filter & sorting option, alteration of Difference Allowed limit and facility of editable fields are disabled.";
                if (!document.getElementById("free-service-notice")) {
                    toolSection.insertBefore(notice, toolSection.querySelector(".control-panel"));
                }
            }
        }

        function resetData() {
            gstr2bData = [];
            gstr3bData = [];
            removeStoredData('gstr2bData');
            removeStoredData('gstr3bData');
            setStoredData('detailedReconciliation', false);
            document.getElementById('gstr2b-container').innerHTML = '';
            document.getElementById('gstr3b-container').innerHTML = '';
            document.getElementById('summary-container').innerHTML = '';
            document.getElementById('output-link').style.display = 'none';
            document.getElementById('gst-file').value = '';
            document.getElementById('diff-allowed').value = '1';
            hideProgress();
        }

        // Debounce function for performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function parseAndFormatDate(dateInput) {
            if (!dateInput || dateInput === '') return '';

            function formatDate(date) {
                const day = String(date.getDate()).padStart(2, '0');
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const month = monthNames[date.getMonth()];
                const year = date.getFullYear();
                return `${day}-${month}-${year}`;
            }

            if (typeof dateInput === 'number' && dateInput > 40000 && dateInput < 50000) {
                const excelEpoch = new Date(1899, 11, 30);
                const days = Math.floor(dateInput);
                const milliseconds = Math.round((dateInput - days) * 86400 * 1000);
                const date = new Date(excelEpoch.getTime() + days * 86400 * 1000 + milliseconds);
                if (dateInput <= 60) {
                    date.setDate(date.getDate() - 1);
                }
                return formatDate(date);
            }

            if (typeof dateInput === 'string') {
                const normalizedInput = dateInput.trim().replace(/[\.\/]/g, '-');
                let date;
                
                const mmmRegex = /^(\d{1,2})-([A-Za-z]{3})-(\d{2,4})$/;
                if (mmmRegex.test(normalizedInput)) {
                    const [, day, monthStr, year] = normalizedInput.match(mmmRegex);
                    const monthNames = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                    const monthIndex = monthNames.indexOf(monthStr.toLowerCase());
                    if (monthIndex !== -1) {
                        const fullYear = year.length === 2 ? (parseInt(year) < 50 ? `20${year}` : `19${year}`) : year;
                        date = new Date(parseInt(fullYear), monthIndex, parseInt(day));
                    }
                }

                if (!date || isNaN(date.getTime())) {
                    const dmyRegex = /^(\d{1,2})-(\d{1,2})-(\d{2,4})$/;
                    if (dmyRegex.test(normalizedInput)) {
                        const [, day, month, year] = normalizedInput.match(dmyRegex);
                        const fullYear = year.length === 2 ? (parseInt(year) < 50 ? `20${year}` : `19${year}`) : year;
                        date = new Date(parseInt(fullYear), parseInt(month) - 1, parseInt(day));
                    }
                }

                if (!date || isNaN(date.getTime())) {
                    date = new Date(normalizedInput);
                }

                if (date && !isNaN(date.getTime())) {
                    return formatDate(date);
                }

                return '';
            }

            if (dateInput instanceof Date && !isNaN(dateInput.getTime())) {
                return formatDate(dateInput);
            }

            return '';
        }

        function formatDate(dateInput) {
            return parseAndFormatDate(dateInput);
        }

        const baseGstr2bHeaders = ['Match Criteria', 'GSTN', 'Name of Supplier', 'Invoice Number', 'Invoice type', 'Invoice Date', 'Invoice Value', 'Place of supply', 'Reverse Charge', 'Rate (%)', 'Taxable Value', 'IGST', 'CGST', 'SGST'];
        const extendedGstr2bHeaders = ['Cess', 'GSTR-1/5 Period', 'GSTR-1/5 Filing Date', 'ITC Availability', 'Reason', 'Applicable % of Tax Rate', 'Source', 'IRN', 'IRN Date'];
        function gstr2bHeaders() { return [...baseGstr2bHeaders, ...extendedGstr2bHeaders]; }

        const baseGstr3bHeaders = ['Match Criteria', 'Invoice Date', 'GSTN', 'Name of Supplier', 'Invoice Number', 'Taxable Value', 'IGST', 'CGST', 'SGST', 'CESS'];
        const extendedGstr3bHeaders = ['Invoice Value'];
        function gstr3bHeaders() { return [...baseGstr3bHeaders, ...extendedGstr3bHeaders]; }

        function generateSampleFile(event) {
            event.preventDefault();
            const wb = XLSX.utils.book_new();
            const gstr2bSampleHeaders = gstr2bHeaders();
            
const gstr2bSample = [
    gstr2bSampleHeaders,
    // Match - GSTN, Invoice No., Date (2 entries)
    ['Match - GSTN, Invoice No., Date', '27AABCU9603R1ZM', 'Supplier A', 'INV001', 'Regular', '01-Mar-2025', 11800, 'Maharashtra', 'N', 18, 10000, 1800, 0, 0, 0, 'Mar-2025', '15-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN001', '02-Mar-2025'],
    ['Match - GSTN, Invoice No., Date', '27AABCU9603R1ZM', 'Supplier A', 'inv001', 'Regular', '01-Mar-2025', 5900, 'Maharashtra', 'N', 18, 5000, 900, 0, 0, 0, 'Mar-2025', '15-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN002', '02-Mar-2025'],
    // Match - GSTN, Invoice No. (2 entries, different dates)
    ['Match - GSTN, Invoice No.', '29XYZ1234P1ZQ', 'Supplier B', 'INV002', 'Regular', '02-Mar-2025', 23600, 'Karnataka', 'N', 9, 20000, 0, 1800, 1800, 0, 'Mar-2025', '16-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-5', 'IRN003', '03-Mar-2025'],
    ['Match - GSTN, Invoice No.', '29XYZ1234P1ZQ', 'Supplier B', 'INV004', 'Regular', '04-Mar-2025', 11800, 'Karnataka', 'N', 9, 10000, 0, 900, 900, 0, 'Mar-2025', '16-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-5', 'IRN004', '04-Mar-2025'],
    // Match - GSTN, Date (2 entries, different invoice numbers)
    ['Match - GSTN, Date', '33ABCDE5678F1Z5', 'Supplier C', 'INV0003', 'Regular', '04-Mar-2025', 14160, 'Tamil Nadu', 'N', 18, 12000, 2160, 0, 0, 0, 'Mar-2025', '17-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN005', '05-Mar-2025'],
    ['Match - GSTN, Date', '33ABCDE5678F1Z5', 'Supplier C', 'INV0004', 'Regular', '04-Mar-2025', 7080, 'Tamil Nadu', 'N', 18, 6000, 1080, 0, 0, 0, 'Mar-2025', '17-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN006', '05-Mar-2025'],
    // Match - GSTN (2 entries, different invoice numbers and dates)
    ['Match - GSTN', '27AABCU9603R2ZM', 'Supplier C', 'INV0005', 'Regular', '31-Mar-2025', 9440, 'Maharashtra', 'N', 18, 8000, 1440, 0, 0, 0, 'Mar-2025', '31-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN007', '06-Mar-2025'],
    ['Match - GSTN', '27AABCU9603R2ZM', 'Supplier C', 'INV0006', 'Regular', '31-Mar-2025', 4720, 'Maharashtra', 'N', 18, 4000, 720, 0, 0, 0, 'Mar-2025', '31-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN008', '07-Mar-2025'],
    // Unmatch - GSTN Not Exist (2 entries)
    ['Unmatch - GSTN Not Exist', '99NOTEXIST1234Z', 'Supplier X', 'INV007', 'Regular', '07-Mar-2025', 11800, 'Delhi', 'N', 18, 10000, 1800, 0, 0, 0, 'Mar-2025', '19-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN009', '08-Mar-2025'],
    ['Unmatch - GSTN Not Exist', '99NOTEXIST5678Z', 'Supplier Y', 'INV008', 'Regular', '08-Mar-2025', 5900, 'Delhi', 'N', 18, 5000, 900, 0, 0, 0, 'Mar-2025', '19-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN010', '09-Mar-2025'],
    // Unmatch - Amt Diff (2 entries, same invoice number, different amounts)
    ['Unmatch - Amt Diff', '27AABCU9603R1ZM', 'Supplier A', 'INV009', 'Regular', '09-Mar-2025', 11802, 'Maharashtra', 'N', 18, 10000, 1802, 0, 0, 0, 'Mar-2025', '20-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN011', '10-Mar-2025'],
    ['Unmatch - Amt Diff', '27AABCU9603R1ZM', 'Supplier A', 'INV009', 'Regular', '09-Mar-2025', 5900, 'Maharashtra', 'N', 5, 5000, 250, 0, 0, 0, 'Mar-2025', '20-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN012', '10-Mar-2025'],
    // Unmatch (2 entries, extra invoices)
    ['Unmatch', '27AABCU9603R1ZM', 'Supplier A', 'INV010', 'Regular', '10-Mar-2025', 7080, 'Maharashtra', 'N', 18, 6000, 1080, 0, 0, 0, 'Mar-2025', '21-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN013', '11-Mar-2025'],
    ['Unmatch', '29XYZ1234P1ZQ', 'Supplier B', 'INV011', 'Regular', '11-Mar-2025', 9440, 'Karnataka', 'N', 9, 8000, 0, 720, 720, 0, 'Mar-2025', '22-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-5', 'IRN014', '12-Mar-2025'],
  ];
          
          
            const ws1 = XLSX.utils.aoa_to_sheet(gstr2bSample);
            gstr2bSampleHeaders.forEach((_, index) => {
                const cell = ws1[XLSX.utils.encode_cell({ r: 0, c: index })];
                if (cell) cell.s = { fill: { fgColor: { rgb: 'E0FFFF' } } };
            });
            XLSX.utils.book_append_sheet(wb, ws1, 'GST Portal');

            const gstr3bSampleHeaders = gstr3bHeaders();
            
            
            const gstr3bSample = [
  gstr3bSampleHeaders,
  ['Match - GSTN, Invoice No., Date', '01-Mar-2025', '27AABCU9603R1ZM', 'Supplier A', 'INV001', 10000, 1800, 0, 0, 0, 11800],
  ['Match - GSTN, Invoice No., Date', '01-Mar-2025', '27AABCU9603R1ZM', 'Supplier A', 'inv001', 5000, 900, 0, 0, 0, 5900],
  ['Match - GSTN, Invoice No.', '03-Mar-2025', '29XYZ1234P1ZQ', 'Supplier B', 'INV002', 20000, 0, 1800, 1800, 200, 23600],
  ['Match - GSTN, Invoice No.', '03-Mar-2025', '29XYZ1234P1ZQ', 'Supplier B', 'INV004', 10000, 0, 900, 900, 100, 11800],
  ['Match - GSTN, Date', '04-Mar-2025', '33ABCDE5678F1Z5', 'Supplier C', 'INV003', 12000, 2160, 0, 0, 0, 14160],
  ['Match - GSTN, Date', '04-Mar-2025', '33ABCDE5678F1Z5', 'Supplier C', 'INV004', 6000, 1080, 0, 0, 0, 7080],
  ['Match - GSTN', '05-Mar-2025', '27AABCU9603R2ZM', 'Supplier C', 'INV005', 8000, 1440, 0, 0, 0, 9440],
  ['Match - GSTN', '06-Mar-2025', '27AABCU9603R2ZM', 'Supplier C', 'INV006', 4000, 720, 0, 0, 0, 4720],
  ['Unmatch - GSTN Not Exist', '07-Mar-2025', '88UNIQUE1234Z', 'Supplier Z', 'INV015', 10000, 1800, 0, 0, 0, 11800],
  ['Unmatch - Amt Diff', '09-Mar-2025', '27AABCU9603R1ZM', 'Supplier A', 'INV009', 10000, 1800, 0, 0, 200, 11800],
  ['Unmatch - Amt Diff', '09-Mar-2025', '27AABCU9603R1ZM', 'Supplier A', 'INV009', 5000, 250, 0, 0, 100, 5250],
  ['Unmatch', '12-Mar-2025', '33ABCDE5678F1Z5', 'Supplier C', 'INV013', 7000, 1260, 0, 0, 0, 8260],
  ['Unmatch', '13-Mar-2025', '29XYZ1234P1ZQ', 'Supplier B', 'INV014', 9000, 0, 810, 810, 150, 10620],
];
           
           
           
           
            const ws2 = XLSX.utils.aoa_to_sheet(gstr3bSample);
            gstr3bSampleHeaders.forEach((_, index) => {
                const cell = ws2[XLSX.utils.encode_cell({ r: 0, c: index })];
                if (cell) cell.s = { fill: { fgColor: { rgb: 'E0FFFF' } } };
            });
            XLSX.utils.book_append_sheet(wb, ws2, 'Client Data');

            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'Sample_GST_Reconciliation.xlsx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function normalizeRow(row, headerLength) {
            const normalized = new Array(headerLength).fill('');
            row.forEach((cell, index) => {
                if (index < headerLength) normalized[index] = cell === undefined || cell === null ? '' : cell;
            });
            return normalized;
        }

        async function handleFileUpload(event) {
            if (isProcessing) return;
            
            const file = event.target.files[0];
            if (!file) return;

            isProcessing = true;
            showProgress();
            updateProgress(0, 'Reading file...');

            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', dateNF: 'dd-mmm-yyyy', raw: true });
                        
                        updateProgress(25, 'Processing GSTR-2B data...');
                        
                        // Process GSTR-2B Data in chunks
                        const gstr2bSheet = workbook.Sheets['GST Portal'];
                        if (gstr2bSheet) {
                            const rawData = XLSX.utils.sheet_to_json(gstr2bSheet, { header: 1, defval: '' });
                            const dataToProcess = rawData.slice(1); // Remove header
                            
                            gstr2bData = await processInChunks(dataToProcess, async (chunk) => {
                                return chunk.map(row => {
                                    const normalized = normalizeRow(row, gstr2bHeaders().length);
                                    const dateIndices = [
                                        gstr2bHeaders().indexOf('Invoice Date'),
                                        gstr2bHeaders().indexOf('GSTR-1/5 Filing Date'),
                                        gstr2bHeaders().indexOf('IRN Date')
                                    ];
                                    dateIndices.forEach(idx => {
                                        if (normalized[idx] !== '') {
                                            normalized[idx] = parseAndFormatDate(normalized[idx]);
                                        }
                                    });
                                    return normalized;
                                });
                            });
                            
                            setStoredData('gstr2bData', gstr2bData);
                            await displayDataAsync(gstr2bData, 'gstr2b-container', gstr2bHeaders(), 'gstr2b');
                        }

                        updateProgress(50, 'Processing GSTR-3B data...');

                        // Process GSTR-3B Data in chunks
                        const gstr3bSheet = workbook.Sheets['Client Data'];
                        if (gstr3bSheet) {
                            const rawData = XLSX.utils.sheet_to_json(gstr3bSheet, { header: 1, defval: '' });
                            const dataToProcess = rawData.slice(1); // Remove header
                            
                            gstr3bData = await processInChunks(dataToProcess, async (chunk) => {
                                return chunk.map(row => {
                                    const normalized = normalizeRow(row, gstr3bHeaders().length);
                                    const dateIndex = gstr3bHeaders().indexOf('Invoice Date');
                                    if (normalized[dateIndex] !== '') {
                                        normalized[dateIndex] = parseAndFormatDate(normalized[dateIndex]);
                                    }
                                    return normalized;
                                });
                            });
                            
                            setStoredData('gstr3bData', gstr3bData);
                            await displayDataAsync(gstr3bData, 'gstr3b-container', gstr3bHeaders(), 'gstr3b');
                        }

                        updateProgress(75, 'Starting reconciliation...');
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        await reconcileData();
                        updateProgress(100, 'Complete!');
                        
                        setTimeout(() => {
                            hideProgress();
                        }, 1000);
                        
                    } catch (error) {
                        console.error('Error processing file:', error);
                        updateProgress(0, 'Error processing file');
                        setTimeout(() => hideProgress(), 2000);
                    } finally {
                        isProcessing = false;
                    }
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('Error reading file:', error);
                hideProgress();
                isProcessing = false;
            }
        }

        async function displayDataAsync(data, containerId, headers, sheetType) {
            const container = document.getElementById(containerId);
            const isFreeService = getStoredData("isFreeService") === "true" || localStorage.getItem("isFreeService") === "true";
            
            // Process in smaller chunks for display
            const DISPLAY_CHUNK_SIZE = 50;
            let html = '<table><thead><tr>';
            headers.forEach(header => html += `<th>${header}</th>`);
            html += '</tr></thead><tbody>';
            
            for (let i = 0; i < data.length; i += DISPLAY_CHUNK_SIZE) {
                const chunk = data.slice(i, i + DISPLAY_CHUNK_SIZE);
                chunk.forEach((row, rowIndex) => {
                    const actualRowIndex = i + rowIndex;
                    html += `<tr data-row="${actualRowIndex}" data-sheet="${sheetType}">`;
                    headers.forEach((_, colIndex) => {
                        const cell = row[colIndex];
                        const isDateColumn = headers[colIndex] === 'Invoice Date' ||
                                            headers[colIndex] === 'GSTR-1/5 Filing Date' ||
                                            headers[colIndex] === 'IRN Date';
                        const value = isDateColumn ? parseAndFormatDate(cell) : (cell === undefined || cell === null ? '' : cell);
                        const isEditable = colIndex > 0 && !isFreeService;
                        html += `<td contenteditable="${isEditable}" data-col="${colIndex}">${value}</td>`;
                    });
                    html += '</tr>';
                });
                
                // Allow UI to update between chunks
                if (i % (DISPLAY_CHUNK_SIZE * 4) === 0) {
                    await new Promise(resolve => setTimeout(resolve, 1));
                }
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
            
            const table = container.querySelector('table');
            table.addEventListener('input', handleCellEdit);
            if (filterEnabled) toggleFilters();

            if (isFreeService) {
                const cells = table.querySelectorAll("td");
                cells.forEach(cell => {
                    cell.setAttribute("contenteditable", "false");
                });
                applyFreeServiceColors();
            }
        }

        function displayData(data, containerId, headers, sheetType) {
            displayDataAsync(data, containerId, headers, sheetType);
        }

        function handleCellEdit(event) {
            const target = event.target;
            const isFreeService = getStoredData("isFreeService") === "true" || localStorage.getItem("isFreeService") === "true";

            if (isFreeService) {
                event.preventDefault();
                target.blur();
                return;
            }

            if (target.tagName === 'TD' && target.hasAttribute('contenteditable') && target.getAttribute('contenteditable') === 'true') {
                const rowIndex = parseInt(target.parentElement.getAttribute('data-row'), 10);
                const colIndex = parseInt(target.getAttribute('data-col'), 10);
                const sheetType = target.parentElement.getAttribute('data-sheet');
                const headers = sheetType === 'gstr2b' ? gstr2bHeaders() : gstr3bHeaders();
                const isDateColumn = headers[colIndex] === 'Invoice Date' ||
                                    headers[colIndex] === 'GSTR-1/5 Filing Date' ||
                                    headers[colIndex] === 'IRN Date';
                let newValue = target.textContent.trim();
                
                if (isDateColumn && newValue !== '') {
                    newValue = parseAndFormatDate(newValue);
                    target.textContent = newValue;
                }

                if (sheetType === 'gstr2b') {
                    gstr2bData[rowIndex][colIndex] = newValue;
                    setStoredData('gstr2bData', gstr2bData);
                } else if (sheetType === 'gstr3b') {
                    gstr3bData[rowIndex][colIndex] = newValue;
                    setStoredData('gstr3bData', gstr3bData);
                }
                
                // Debounced reconciliation for performance
                debounce(reconcileData, 1000)();
                if (filterEnabled) {
                    refreshFilters(sheetType === 'gstr2b' ? 'gstr2b-container' : 'gstr3b-container');
                }
            }
        }

        function refreshFilters(containerId) {
            const table = document.getElementById(containerId).querySelector('table');
            if (table) {
                const headers = table.querySelectorAll('thead th');
                headers.forEach((th, colIndex) => {
                    const dropdown = th.querySelector('.filter-dropdown');
                    if (dropdown) {
                        const optionsDiv = dropdown.querySelector('.filter-options');
                        populateFilterOptions(optionsDiv, containerId, colIndex);
                        applyFilters(containerId);
                    }
                });
            }
        }

        async function reconcileData() {
            if (isProcessing) return;
            if (gstr2bData.length === 0 && gstr3bData.length === 0) return;

            isProcessing = true;
            
            // Show progress for large datasets
            if (gstr2bData.length > 200 || gstr3bData.length > 200) {
                showProgress();
                updateProgress(0, 'Starting reconciliation...');
            }

            try {
                const diffInput = document.getElementById('diff-allowed').value;
                const diffAllowed = diffInput === '' ? 0 : Number(diffInput) || 1;
                const gstr2bTable = document.querySelector('#gstr2b-container table tbody');
                const gstr3bTable = document.querySelector('#gstr3b-container table tbody');
                const reconciled2bData = [];
                const reconciled3bData = [];

                // Process GSTR-2B data in chunks
                updateProgress(20, 'Reconciling GSTR-2B data...');
                await new Promise(resolve => setTimeout(resolve, 10));

                const process2bChunk = async (chunk, chunkIndex) => {
                    return chunk.map((row, index) => {
                        const actualIndex = chunkIndex * CHUNK_SIZE + index;
                        const match = findMatch(row, gstr2bData, gstr3bData, false, diffAllowed);
                        const newRow = [match, ...row.slice(1)];
                        reconciled2bData[actualIndex] = newRow;
                        if (gstr2bTable && gstr2bTable.rows[actualIndex]) {
                            updateRow(gstr2bTable.rows[actualIndex], newRow);
                        }
                        return newRow;
                    });
                };

                await processInChunks(gstr2bData, process2bChunk);

                // Process GSTR-3B data in chunks
                updateProgress(60, 'Reconciling GSTR-3B data...');
                await new Promise(resolve => setTimeout(resolve, 10));

                const process3bChunk = async (chunk, chunkIndex) => {
                    return chunk.map((row, index) => {
                        const actualIndex = chunkIndex * CHUNK_SIZE + index;
                        const match = findMatch(row, gstr3bData, gstr2bData, true, diffAllowed);
                        const newRow = [match, ...row.slice(1)];
                        reconciled3bData[actualIndex] = newRow;
                        if (gstr3bTable && gstr3bTable.rows[actualIndex]) {
                            updateRow(gstr3bTable.rows[actualIndex], newRow);
                        }
                        return newRow;
                    });
                };

                await processInChunks(gstr3bData, process3bChunk);

                updateProgress(80, 'Generating summary...');
                await new Promise(resolve => setTimeout(resolve, 10));

                displaySummary(reconciled2bData, reconciled3bData);
                
                updateProgress(90, 'Preparing output...');
                await new Promise(resolve => setTimeout(resolve, 10));
                
                await generateOutput(reconciled2bData, reconciled3bData);

                restrictFreeServiceFeatures();
                
                updateProgress(100, 'Reconciliation complete!');
                setTimeout(() => hideProgress(), 1000);

            } catch (error) {
                console.error('Error during reconciliation:', error);
                hideProgress();
            } finally {
                isProcessing = false;
            }
        }

        function updateRow(rowElement, newRow) {
    const match = newRow[0];
    Array.from(rowElement.cells).forEach((cell, index) => {
        cell.textContent = newRow[index];
    });
    // Skip color coding if dataset size exceeds 1000 rows
    if (gstr2bData.length + gstr3bData.length <= 1000) {
        colorRow(rowElement, match);
    }
}

        function normalizeInvoiceNumber(invNum) {
            return String(invNum).replace(/[\s\/\\.,"?\']/g, '').toLowerCase().trim();
        }

        function findMatch(row, sourceData, compareData, is3b, diffAllowed) {
            const sourceHeaders = is3b ? gstr3bHeaders() : gstr2bHeaders();
            const compareHeaders = is3b ? gstr2bHeaders() : gstr3bHeaders();
            const invDateIdx = sourceHeaders.indexOf('Invoice Date');
            const gstnIdx = sourceHeaders.indexOf('GSTN');
            const invNumIdx = sourceHeaders.indexOf('Invoice Number');
            const compareGstnIdx = compareHeaders.indexOf('GSTN');
            const invDate = parseAndFormatDate(row[invDateIdx]).toLowerCase().trim();
            const gstn = String(row[gstnIdx]).toLowerCase().trim();
            const invNum = normalizeInvoiceNumber(String(row[invNumIdx]));

            // 1. Match - GSTN, Invoice No., Date
            const sourceTotals = calculateTotals(sourceData, invDate, gstn, invNum, is3b);
            const compareTotals = calculateTotals(compareData, invDate, gstn, invNum, !is3b);
            if (sourceTotals.count > 0 && compareTotals.count > 0) {
                if (checkTotals(sourceTotals, compareTotals, diffAllowed)) {
                    return detailedReconciliationCheckbox.checked ? 'Match - GSTN, Invoice No., Date' : 'Match';
                }
            }

            // 2. Match - GSTN, Invoice No.
            const invTotals = calculateTotalsByInv(sourceData, gstn, invNum, is3b);
            const compareInvTotals = calculateTotalsByInv(compareData, gstn, invNum, !is3b);
            if (invTotals.count > 0 && compareInvTotals.count > 0) {
                if (checkTotals(invTotals, compareInvTotals, diffAllowed)) {
                    return detailedReconciliationCheckbox.checked ? 'Match - GSTN, Invoice No.' : 'Match';
                }
            }

            // 3. Match - GSTN, Date
            const gstnDateTotals = calculateTotalsByGstnDate(sourceData, invDate, gstn, is3b);
            const compareGstnDateTotals = calculateTotalsByGstnDate(compareData, invDate, gstn, !is3b);
            if (gstnDateTotals.count > 0 && compareGstnDateTotals.count > 0) {
                if (checkTotals(gstnDateTotals, compareGstnDateTotals, diffAllowed)) {
                    return detailedReconciliationCheckbox.checked ? 'Match - GSTN, Date' : 'Match';
                }
            }

            // 4. Match - GSTN
            const gstnTotals = calculateTotalsByGstn(sourceData, gstn, is3b);
            const compareGstnTotals = calculateTotalsByGstn(compareData, gstn, !is3b);
            if (gstnTotals.count > 0 && compareGstnTotals.count > 0) {
                if (checkTotals(gstnTotals, compareGstnTotals, diffAllowed)) {
                    return detailedReconciliationCheckbox.checked ? 'Match - GSTN' : 'Match';
                }
            }

            // 5. Unmatch - GSTN Not Exist
            const gstnExistsInCompare = compareData.some(r => String(r[compareGstnIdx]).toLowerCase().trim() === gstn);
            if (!gstnExistsInCompare) {
                return 'Unmatch - GSTN Not Exist';
            }

            // 6. Unmatch - Amt Diff
            const amtDiffTotals = calculateTotalsByInv(sourceData, gstn, invNum, is3b);
            const compareAmtDiffTotals = calculateTotalsByInv(compareData, gstn, invNum, !is3b);
            if (amtDiffTotals.count > 0 && compareAmtDiffTotals.count > 0) {
                if (!checkTotals(amtDiffTotals, compareAmtDiffTotals, diffAllowed)) {
                    return 'Unmatch - Amt Diff';
                }
            }

            // 7. Unmatch
            return 'Unmatch';
        }

        function calculateTotals(data, invDate, gstn, invNum, is3b) {
            const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
            const invDateIdx = headers.indexOf('Invoice Date');
            const gstnIdx = headers.indexOf('GSTN');
            const invNumIdx = headers.indexOf('Invoice Number');
            const taxableIdx = headers.indexOf('Taxable Value');
            const igstIdx = headers.indexOf('IGST');
            const cgstIdx = headers.indexOf('CGST');
            const sgstIdx = headers.indexOf('SGST');
            const cessIdx = headers.indexOf('CESS');
            let count = 0, taxable = 0, igst = 0, cgst = 0, sgst = 0, cess = 0;
            data.forEach(row => {
                const rowDate = parseAndFormatDate(row[invDateIdx]).toLowerCase().trim();
                if (rowDate === invDate && 
                    String(row[gstnIdx]).toLowerCase().trim() === gstn && 
                    normalizeInvoiceNumber(String(row[invNumIdx])) === invNum) {
                    count++;
                    taxable += Number(row[taxableIdx]) || 0;
                    igst += Number(row[igstIdx]) || 0;
                    cgst += Number(row[cgstIdx]) || 0;
                    sgst += Number(row[sgstIdx]) || 0;
                    cess += Number(row[cessIdx]) || 0;
                }
            });
            return { count, taxable, igst, cgst, sgst, cess };
        }

        function calculateTotalsByInv(data, gstn, invNum, is3b) {
            const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
            const gstnIdx = headers.indexOf('GSTN');
            const invNumIdx = headers.indexOf('Invoice Number');
            const taxableIdx = headers.indexOf('Taxable Value');
            const igstIdx = headers.indexOf('IGST');
            const cgstIdx = headers.indexOf('CGST');
            const sgstIdx = headers.indexOf('SGST');
            const cessIdx = headers.indexOf('CESS');
            let count = 0, taxable = 0, igst = 0, cgst = 0, sgst = 0, cess = 0;
            data.forEach(row => {
                if (String(row[gstnIdx]).toLowerCase().trim() === gstn && 
                    normalizeInvoiceNumber(String(row[invNumIdx])) === invNum) {
                    count++;
                    taxable += Number(row[taxableIdx]) || 0;
                    igst += Number(row[igstIdx]) || 0;
                    cgst += Number(row[cgstIdx]) || 0;
                    sgst += Number(row[sgstIdx]) || 0;
                    cess += Number(row[cessIdx]) || 0;
                }
            });
            return { count, taxable, igst, cgst, sgst, cess };
        }

        function calculateTotalsByGstnDate(data, invDate, gstn, is3b) {
            const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
            const invDateIdx = headers.indexOf('Invoice Date');
            const gstnIdx = headers.indexOf('GSTN');
            const taxableIdx = headers.indexOf('Taxable Value');
            const igstIdx = headers.indexOf('IGST');
            const cgstIdx = headers.indexOf('CGST');
            const sgstIdx = headers.indexOf('SGST');
            const cessIdx = headers.indexOf('CESS');
            let count = 0, taxable = 0, igst = 0, cgst = 0, sgst = 0, cess = 0;
            data.forEach(row => {
                const rowDate = parseAndFormatDate(row[invDateIdx]).toLowerCase().trim();
                if (rowDate === invDate && 
                    String(row[gstnIdx]).toLowerCase().trim() === gstn) {
                    count++;
                    taxable += Number(row[taxableIdx]) || 0;
                    igst += Number(row[igstIdx]) || 0;
                    cgst += Number(row[cgstIdx]) || 0;
                    sgst += Number(row[sgstIdx]) || 0;
                    cess += Number(row[cessIdx]) || 0;
                }
            });
            return { count, taxable, igst, cgst, sgst, cess };
        }

        function calculateTotalsByGstn(data, gstn, is3b) {
            const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
            const gstnIdx = headers.indexOf('GSTN');
            const taxableIdx = headers.indexOf('Taxable Value');
            const igstIdx = headers.indexOf('IGST');
            const cgstIdx = headers.indexOf('CGST');
            const sgstIdx = headers.indexOf('SGST');
            const cessIdx = headers.indexOf('CESS');
            let count = 0, taxable = 0, igst = 0, cgst = 0, sgst = 0, cess = 0;
            data.forEach(row => {
                if (String(row[gstnIdx]).toLowerCase().trim() === gstn) {
                    count++;
                    taxable += Number(row[taxableIdx]) || 0;
                    igst += Number(row[igstIdx]) || 0;
                    cgst += Number(row[cgstIdx]) || 0;
                    sgst += Number(row[sgstIdx]) || 0;
                    cess += Number(row[cessIdx]) || 0;
                }
            });
            return { count, taxable, igst, cgst, sgst, cess };
        }

        function checkTotals(source, compare, diffAllowed) {
            return Math.abs(source.taxable - compare.taxable) <= diffAllowed &&
                   Math.abs(source.igst - compare.igst) <= diffAllowed &&
                   Math.abs(source.cgst - compare.cgst) <= diffAllowed &&
                   Math.abs(source.sgst - compare.sgst) <= diffAllowed &&
                   Math.abs(source.cess - compare.cess) <= diffAllowed;
        }

        function applyFreeServiceColors() {
            const isFreeService = getStoredData("isFreeService") === "true" || localStorage.getItem("isFreeService") === "true";
            if (!isFreeService) return;

            const tables = document.querySelectorAll("#gstr2b-container table, #gstr3b-container table, #summary-container table");
            tables.forEach(table => {
                const rows = table.querySelectorAll("tbody tr");
                rows.forEach(row => {
                    const match = row.cells[0].textContent;
                    let backgroundColor = '#f0f0f0';
                    let textColor = 'black';

                    if (detailedReconciliationCheckbox.checked) {
                        switch (match) {
                            case 'Match - GSTN, Invoice No., Date':
                                backgroundColor = '#00ced1';
                                textColor = 'white';
                                break;
                            case 'Match - GSTN, Invoice No.':
                                backgroundColor = '#4b0082';
                                textColor = 'white';
                                break;
                            case 'Match - GSTN, Date':
                                backgroundColor = '#32cd32';
                                textColor = 'white';
                                break;
                            case 'Match - GSTN':
                                backgroundColor = '#ffbf00';
                                textColor = 'black';
                                break;
                            case 'Unmatch - GSTN Not Exist':
                                backgroundColor = '#dc143c';
                                textColor = 'white';
                                break;
                            case 'Unmatch - Amt Diff':
                                backgroundColor = '#ff4500';
                                textColor = 'white';
                                break;
                            case 'Unmatch':
                                backgroundColor = '#ff00ff';
                                textColor = 'white';
                                break;
                            default:
                                backgroundColor = '#ff00ff';
                                textColor = 'white';
                                break;
                        }
                    } else {
                        switch (match) {
                            case 'Match':
                                backgroundColor = '#00ced1';
                                textColor = 'white';
                                break;
                            case 'Unmatch - GSTN Not Exist':
                                backgroundColor = '#dc143c';
                                textColor = 'white';
                                break;
                            case 'Unmatch - Amt Diff':
                                backgroundColor = '#ff4500';
                                textColor = 'white';
                                break;
                            case 'Unmatch':
                                backgroundColor = '#ff00ff';
                                textColor = 'white';
                                break;
                            default:
                                backgroundColor = '#ff00ff';
                                textColor = 'white';
                                break;
                        }
                    }

                    const cells = row.querySelectorAll("td");
                    cells.forEach(cell => {
                        cell.style.backgroundColor = backgroundColor;
                        cell.style.color = textColor;
                        cell.style.fontWeight = 'normal';
                    });
                });
            });
        }

        function colorRow(rowElement, match) {
            rowElement.className = '';
            let backgroundColor = '';
            let textColor = 'white';

            if (detailedReconciliationCheckbox.checked) {
                switch (match) {
                    case 'Match - GSTN, Invoice No., Date':
                        backgroundColor = '#00ced1';
                        break;
                    case 'Match - GSTN, Invoice No.':
                        backgroundColor = '#4b0082';
                        break;
                    case 'Match - GSTN, Date':
                        backgroundColor = '#32cd32';
                        break;
                    case 'Match - GSTN':
                        backgroundColor = '#ffbf00';
                        textColor = 'black';
                        break;
                    case 'Unmatch - GSTN Not Exist':
                        backgroundColor = '#dc143c';
                        break;
                    case 'Unmatch - Amt Diff':
                        backgroundColor = '#ff4500';
                        break;
                    default:
                        backgroundColor = '#ff00ff';
                        break;
                }
            } else {
                switch (match) {
                    case 'Match':
                        backgroundColor = '#00ced1';
                        break;
                    case 'Unmatch - GSTN Not Exist':
                        backgroundColor = '#dc143c';
                        break;
                    case 'Unmatch - Amt Diff':
                        backgroundColor = '#ff4500';
                        break;
                    default:
                        backgroundColor = '#ff00ff';
                        break;
                }
            }

            Array.from(rowElement.cells).forEach(cell => {
                cell.style.backgroundColor = backgroundColor;
                cell.style.color = textColor;
                cell.style.fontWeight = 'normal';
            });
        }

        function calculateSummary(data, is3b) {
    const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
    const taxableIdx = headers.indexOf('Taxable Value');
    const igstIdx = headers.indexOf('IGST');
    const cgstIdx = headers.indexOf('CGST');
    const sgstIdx = headers.indexOf('SGST');
    const cessIdx = headers.indexOf('CESS');
    const criteria = detailedReconciliationCheckbox.checked ?
        ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'] :
        ['Match', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'];
    const summary = {};
    criteria.forEach(criterion => {
        summary[criterion] = { taxable: 0, igst: 0, cgst: 0, sgst: 0, cess: 0 };
    });
    data.forEach(row => {
        let match = row[0];
        if (!detailedReconciliationCheckbox.checked && 
            ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN'].includes(match)) {
            match = 'Match';
        }
        if (summary[match]) {
            summary[match].taxable += Number(row[taxableIdx]) || 0; // Removed +1
            summary[match].igst += Number(row[igstIdx]) || 0; // Removed +1
            summary[match].cgst += Number(row[cgstIdx]) || 0; // Removed +1
            summary[match].sgst += Number(row[sgstIdx]) || 0; // Removed +1
            summary[match].cess += Number(row[cessIdx]) || 0; // Removed +1
        }
    });
    const total = { taxable: 0, igst: 0, cgst: 0, sgst: 0, cess: 0 };
    criteria.forEach(criterion => {
        total.taxable += summary[criterion].taxable;
        total.igst += summary[criterion].igst;
        total.cgst += summary[criterion].cgst;
        total.sgst += summary[criterion].sgst;
        total.cess += summary[criterion].cess;
    });
    return { summary, total };
}

        function displaySummary(reconciled2bData, reconciled3bData) {
    const gstr2bSummary = calculateSummary(reconciled2bData, false);
    const gstr3bSummary = calculateSummary(reconciled3bData, true);
    const container = document.getElementById('summary-container');
    let html = '<table><thead><tr>';
    html += '<th rowspan="2">Particulars</th>';
    html += '<th colspan="5">GST Portal</th>';
    html += '<th colspan="5">Client Data</th>';
    html += '</tr><tr>';
    ['Taxable Value', 'IGST', 'CGST', 'SGST', 'CESS'].forEach(header => html += `<th>${header}</th>`);
    ['Taxable Value', 'IGST', 'CGST', 'SGST', 'CESS'].forEach(header => html += `<th>${header}</th>`);
    html += '</tr></thead><tbody>';
    const criteria = detailedReconciliationCheckbox.checked ?
        ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'] :
        ['Match', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'];
    
    // Check if dataset size exceeds 1000 rows
    const skipColorCoding = (gstr2bData.length + gstr3bData.length > 1000);
    
    criteria.forEach(criterion => {
        let backgroundColor = skipColorCoding ? '' : '#00ced1';
        let textColor = skipColorCoding ? 'black' : 'white';
        if (!skipColorCoding && detailedReconciliationCheckbox.checked) {
            switch (criterion) {
                case 'Match - GSTN, Invoice No., Date':
                    backgroundColor = '#00ced1';
                    break;
                case 'Match - GSTN, Invoice No.':
                    backgroundColor = '#4b0082';
                    break;
                case 'Match - GSTN, Date':
                    backgroundColor = '#32cd32';
                    break;
                case 'Match - GSTN':
                    backgroundColor = '#ffbf00';
                    textColor = 'black';
                    break;
                case 'Unmatch - GSTN Not Exist':
                    backgroundColor = '#dc143c';
                    break;
                case 'Unmatch - Amt Diff':
                    backgroundColor = '#ff4500';
                    break;
                default:
                    backgroundColor = '#ff00ff';
                    break;
            }
        } else if (!skipColorCoding) {
            switch (criterion) {
                case 'Match':
                    backgroundColor = '#00ced1';
                    break;
                case 'Unmatch - GSTN Not Exist':
                    backgroundColor = '#dc143c';
                    break;
                case 'Unmatch - Amt Diff':
                    backgroundColor = '#ff4500';
                    break;
                default:
                    backgroundColor = '#ff00ff';
                    break;
            }
        }
        html += '<tr>';
        html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${criterion}</td>`;
        html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr2bSummary.summary[criterion]?.taxable || 0).toFixed(2)}</td>`;
        html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr2bSummary.summary[criterion]?.igst || 0).toFixed(2)}</td>`;
        html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr2bSummary.summary[criterion]?.cgst || 0).toFixed(2)}</td>`;
        html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr2bSummary.summary[criterion]?.sgst || 0).toFixed(2)}</td>`;
        html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr2bSummary.summary[criterion]?.cess || 0).toFixed(2)}</td>`;
        html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr3bSummary.summary[criterion]?.taxable || 0).toFixed(2)}</td>`;
        html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr3bSummary.summary[criterion]?.igst || 0).toFixed(2)}</td>`;
        html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr3bSummary.summary[criterion]?.cgst || 0).toFixed(2)}</td>`;
        html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr3bSummary.summary[criterion]?.sgst || 0).toFixed(2)}</td>`;
        html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr3bSummary.summary[criterion]?.cess || 0).toFixed(2)}</td>`;
        html += '</tr>';
    });
    html += '<tr style="font-weight: bold;">';
    html += '<td><strong>Total</strong></td>';
    html += `<td><strong>${gstr2bSummary.total.taxable.toFixed(2)}</strong></td>`;
    html += `<td><strong>${gstr2bSummary.total.igst.toFixed(2)}</strong></td>`;
    html += `<td><strong>${gstr2bSummary.total.cgst.toFixed(2)}</strong></td>`;
    html += `<td><strong>${gstr2bSummary.total.sgst.toFixed(2)}</strong></td>`;
    html += `<td><strong>${gstr2bSummary.total.cess.toFixed(2)}</strong></td>`;
    html += `<td><strong>${gstr3bSummary.total.taxable.toFixed(2)}</strong></td>`;
    html += `<td><strong>${gstr3bSummary.total.igst.toFixed(2)}</strong></td>`;
    html += `<td><strong>${gstr3bSummary.total.cgst.toFixed(2)}</strong></td>`;
    html += `<td><strong>${gstr3bSummary.total.sgst.toFixed(2)}</strong></td>`;
    html += `<td><strong>${gstr3bSummary.total.cess.toFixed(2)}</strong></td>`;
    html += '</tr>';
    html += '</tbody></table>';
    container.innerHTML = html;

    if ((getStoredData("isFreeService") === "true" || localStorage.getItem("isFreeService") === "true") && !skipColorCoding) {
        applyFreeServiceColors();
    }
}

        async function generateOutput(reconciled2bData, reconciled3bData) {
            const workbook = new ExcelJS.Workbook();
            const ws1 = workbook.addWorksheet('GST Portal');
            const headerRow1 = ws1.addRow(gstr2bHeaders());
            headerRow1.eachCell(cell => {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0FFFF' } };
            });
            reconciled2bData.forEach(row => {
                const excelRow = row.map((cell, idx) => {
                    const isDateColumn = gstr2bHeaders()[idx] === 'Invoice Date' ||
                                        gstr2bHeaders()[idx] === 'GSTR-1/5 Filing Date' ||
                                        gstr2bHeaders()[idx] === 'IRN Date';
                    return isDateColumn && cell !== '' ? parseAndFormatDate(cell) : (cell === undefined || cell === null ? '' : cell);
                });
                const addedRow = ws1.addRow(excelRow);
                applyExcelRowColor(addedRow, row[0], gstr2bHeaders().length);
            });
            const ws2 = workbook.addWorksheet('Client Data');
            const headerRow2 = ws2.addRow(gstr3bHeaders());
            headerRow2.eachCell(cell => {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0FFFF' } };
            });
            reconciled3bData.forEach(row => {
                const excelRow = row.map((cell, idx) => {
                    const isDateColumn = gstr3bHeaders()[idx] === 'Invoice Date';
                    return isDateColumn && cell !== '' ? parseAndFormatDate(cell) : (cell === undefined || cell === null ? '' : cell);
                });
                const addedRow = ws2.addRow(excelRow);
                applyExcelRowColor(addedRow, row[0], gstr3bHeaders().length);
            });

            const ws3 = workbook.addWorksheet('Summary');
            const summaryHeader1 = ws3.addRow(['Particulars', 'GST Portal', '', '', '', '', 'Client Data', '', '', '', '']);
            const summaryHeader2 = ws3.addRow(['', 'Taxable Value', 'IGST', 'CGST', 'SGST', 'CESS', 'Taxable Value', 'IGST', 'CGST', 'SGST', 'CESS']);
            ws3.mergeCells('A1:A2');
            ws3.mergeCells('B1:F1');
            ws3.mergeCells('G1:K1');
            [summaryHeader1, summaryHeader2].forEach(row => {
                row.eachCell(cell => {
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0FFFF' } };
                });
            });
            const gstr2bSummary = calculateSummary(reconciled2bData, false);
            const gstr3bSummary = calculateSummary(reconciled3bData, true);
            const criteria = detailedReconciliationCheckbox.checked ?
                ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'] :
                ['Match', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'];
            criteria.forEach(criterion => {
                const row = ws3.addRow([
                    criterion,
                    gstr2bSummary.summary[criterion].taxable,
                    gstr2bSummary.summary[criterion].igst,
                    gstr2bSummary.summary[criterion].cgst,
                    gstr2bSummary.summary[criterion].sgst,
                    gstr2bSummary.summary[criterion].cess,
                    gstr3bSummary.summary[criterion].taxable,
                    gstr3bSummary.summary[criterion].igst,
                    gstr3bSummary.summary[criterion].cgst,
                    gstr3bSummary.summary[criterion].sgst,
                    gstr3bSummary.summary[criterion].cess
                ]);
                
                // Apply color to summary rows
                const colors = detailedReconciliationCheckbox.checked ? {
                    'Match - GSTN, Invoice No., Date': 'FF00CED1',
                    'Match - GSTN, Invoice No.': 'FF4B0082',
                    'Match - GSTN, Date': 'FF32CD32',
                    'Match - GSTN': 'FFFFBF00',
                    'Unmatch - GSTN Not Exist': 'FFDC143C',
                    'Unmatch - Amt Diff': 'FFFF4500',
                    'Unmatch': 'FFFF00FF'
                } : {
                    'Match': 'FF00CED1',
                    'Unmatch - GSTN Not Exist': 'FFDC143C',
                    'Unmatch - Amt Diff': 'FFFF4500',
                    'Unmatch': 'FFFF00FF'
                };
                
                const color = colors[criterion] || 'FFFF00FF';
                row.eachCell(cell => {
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: color } };
                    cell.font = { color: { argb: 'FFFFFFFF' } };
                });
            });
            
            const totalRow = ws3.addRow([
                'Total',
                gstr2bSummary.total.taxable,
                gstr2bSummary.total.igst,
                gstr2bSummary.total.cgst,
                gstr2bSummary.total.sgst,
                gstr2bSummary.total.cess,
                gstr3bSummary.total.taxable,
                gstr3bSummary.total.igst,
                gstr3bSummary.total.cgst,
                gstr3bSummary.total.sgst,
                gstr3bSummary.total.cess
            ]);

            totalRow.eachCell(cell => { cell.font = { bold: true }; });
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const link = document.getElementById('download-output');
            link.href = url;
            link.download = 'Reconciled_GST_Data.xlsx';
            document.getElementById('output-link').style.display = 'block';
        }

        function applyExcelRowColor(row, match, columnCount) {
            const colors = detailedReconciliationCheckbox.checked ? {
                'Match - GSTN, Invoice No., Date': 'FF00CED1',
                'Match - GSTN, Invoice No.': 'FF4B0082',
                'Match - GSTN, Date': 'FF32CD32',
                'Match - GSTN': 'FFFFBF00',
                'Unmatch - GSTN Not Exist': 'FFDC143C',
                'Unmatch - Amt Diff': 'FFFF4500',
                'Unmatch': 'FFFF00FF'
            } : {
                'Match': 'FF00CED1',
                'Unmatch - GSTN Not Exist': 'FFDC143C',
                'Unmatch - Amt Diff': 'FFFF4500',
                'Unmatch': 'FFFF00FF'
            };
            const color = colors[match] || 'FFFF00FF';
            for (let i = 1; i <= columnCount; i++) {
                const cell = row.getCell(i);
                cell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: color }
                };
                if ((detailedReconciliationCheckbox.checked && 
                    ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'].includes(match)) ||
                    (!detailedReconciliationCheckbox.checked && 
                    ['Match', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'].includes(match))) {
                    cell.font = { color: { argb: 'FFFFFFFF' } };
                }
            }
        }

        // Filter State
        let filterEnabled = false;
        const filters = {};

        document.getElementById('enable-filter').addEventListener('change', function () {
            filterEnabled = this.checked;
            toggleFilters();
        });

        function toggleFilters() {
            const containers = ['gstr2b-container', 'gstr3b-container'];
            containers.forEach(containerId => {
                const table = document.getElementById(containerId).querySelector('table');
                if (table) {
                    const headers = table.querySelectorAll('thead th');
                    headers.forEach((th, colIndex) => {
                        if (filterEnabled) {
                            addFilterDropdown(th, containerId, colIndex);
                        } else {
                            removeFilterDropdown(th);
                        }
                    });
                    if (!filterEnabled) {
                        resetFilters(containerId);
                    }
                }
            });
        }

        function addFilterDropdown(th, containerId, colIndex) {
            if (th.querySelector('.filter-dropdown')) return;
            const headerText = th.textContent.trim();
            const dropdown = document.createElement('div');
            dropdown.className = 'filter-dropdown';

            const filterBtn = document.createElement('button');
            filterBtn.className = 'filter-btn';
            filterBtn.innerHTML = '<i class="fas fa-filter"></i>'; // Funnel icon added
            filterBtn.addEventListener('click', () => toggleDropdown(dropdown));

            const dropdownContent = document.createElement('div');
            dropdownContent.className = 'filter-dropdown-content';

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'filter-input';
            input.placeholder = `Filter ${headerText}`;
            input.addEventListener('input', () => filterOptions(input, dropdownContent, containerId, colIndex));

            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'filter-options';
            populateFilterOptions(optionsDiv, containerId, colIndex);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'filter-actions';
            const selectAllBtn = document.createElement('button');
            selectAllBtn.textContent = 'Select All';
            selectAllBtn.addEventListener('click', () => selectAllOptions(optionsDiv, containerId, colIndex));
            const uncheckAllBtn = document.createElement('button');
            uncheckAllBtn.textContent = 'Uncheck All';
            uncheckAllBtn.addEventListener('click', () => uncheckAllOptions(optionsDiv, containerId, colIndex));
            actionsDiv.appendChild(selectAllBtn);
            actionsDiv.appendChild(uncheckAllBtn);

            const sortDiv = document.createElement('div');
            sortDiv.className = 'sort-actions';
            const sortAscBtn = document.createElement('button');
            sortAscBtn.textContent = 'Sort A-Z';
            sortAscBtn.addEventListener('click', () => sortTable(containerId, colIndex, 'asc'));
            const sortDescBtn = document.createElement('button');
            sortDescBtn.textContent = 'Sort Z-A';
            sortDescBtn.addEventListener('click', () => sortTable(containerId, colIndex, 'desc'));
            sortDiv.appendChild(sortAscBtn);
            sortDiv.appendChild(sortDescBtn);

            dropdownContent.appendChild(input);
            dropdownContent.appendChild(optionsDiv);
            dropdownContent.appendChild(actionsDiv);
            dropdownContent.appendChild(sortDiv);
            dropdown.appendChild(filterBtn);
            dropdown.appendChild(dropdownContent);
            th.appendChild(dropdown);
        }

        function uncheckAllOptions(optionsDiv, containerId, colIndex) {
            const checkboxes = optionsDiv.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            applyFilters(containerId);
        }

        function removeFilterDropdown(th) {
            const dropdown = th.querySelector('.filter-dropdown');
            if (dropdown) dropdown.remove();
        }

        function toggleDropdown(dropdown) {
            const content = dropdown.querySelector('.filter-dropdown-content');
            document.querySelectorAll('.filter-dropdown-content.show').forEach(otherDropdown => {
                if (otherDropdown !== content) {
                    otherDropdown.classList.remove('show');
                }
            });
            content.classList.toggle('show');
        }

        function populateFilterOptions(optionsDiv, containerId, colIndex) {
            const table = document.getElementById(containerId).querySelector('table');
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const uniqueValues = new Set(rows.map(row => row.cells[colIndex].textContent.trim()));
            optionsDiv.innerHTML = '';
            uniqueValues.forEach(value => {
                const option = document.createElement('div');
                option.className = 'filter-option';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = value;
                checkbox.checked = true;
                checkbox.addEventListener('change', () => applyFilters(containerId));
                const label = document.createElement('label');
                label.textContent = value || '(Blank)';
                option.appendChild(checkbox);
                option.appendChild(label);
                optionsDiv.appendChild(option);
            });
        }

        function sortTable(containerId, colIndex, direction) {
            const table = document.getElementById(containerId).querySelector('table');
            const rows = Array.from(table.querySelectorAll('tbody tr'));

            rows.sort((a, b) => {
                const aValue = a.cells[colIndex].textContent.trim().toLowerCase();
                const bValue = b.cells[colIndex].textContent.trim().toLowerCase();

                const isGSTNColumn = (containerId === 'gstr2b-container' && colIndex === 1) || 
                                   (containerId === 'gstr3b-container' && colIndex === 2);

                if (isGSTNColumn) {
                    const aStateCode = parseInt(aValue.slice(0, 2), 10);
                    const bStateCode = parseInt(bValue.slice(0, 2), 10);
                    const aRest = aValue.slice(2);
                    const bRest = bValue.slice(2);

                    if (aStateCode !== bStateCode) {
                        return direction === 'asc' ? aStateCode - bStateCode : bStateCode - aStateCode;
                    }

                    return direction === 'asc' 
                        ? aRest.localeCompare(bRest, undefined, { numeric: true, sensitivity: 'base' })
                        : bRest.localeCompare(aRest, undefined, { numeric: true, sensitivity: 'base' });
                }

                const aNum = parseFloat(aValue);
                const bNum = parseFloat(bValue);
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return direction === 'asc' ? aNum - bNum : bNum - aNum;
                }

                const aDate = Date.parse(aValue);
                const bDate = Date.parse(bValue);
                if (!isNaN(aDate) && !isNaN(bDate)) {
                    return direction === 'asc' ? aDate - bDate : bDate - aDate;
                }

                return direction === 'asc' 
                    ? aValue.localeCompare(bValue, undefined, { numeric: true, sensitivity: 'base' })
                    : bValue.localeCompare(aValue, undefined, { numeric: true, sensitivity: 'base' });
            });

            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
            applyFilters(containerId);
        }

        function filterOptions(input, dropdownContent, containerId, colIndex) {
            const filterText = input.value.toLowerCase();
            const optionsDiv = dropdownContent.querySelector('.filter-options');
            const options = optionsDiv.querySelectorAll('.filter-option');
            options.forEach(option => {
                const label = option.querySelector('label').textContent.toLowerCase();
                option.style.display = label.includes(filterText) ? 'flex' : 'none';
            });
            applyFilters(containerId);
        }

        function applyFilters(containerId) {
            const table = document.getElementById(containerId).querySelector('table');
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const headers = table.querySelectorAll('thead th');

            if (!filters[containerId]) filters[containerId] = {};

            rows.forEach(row => {
                let showRow = true;
                headers.forEach((th, colIndex) => {
                    const dropdown = th.querySelector('.filter-dropdown-content');
                    if (dropdown) {
                        const selectedValues = Array.from(dropdown.querySelectorAll('input[type="checkbox"]:checked'))
                            .map(cb => cb.value);
                        const cellValue = row.cells[colIndex].textContent.trim();
                        if (selectedValues.length > 0 && !selectedValues.includes(cellValue)) {
                            showRow = false;
                        }
                    }
                });
                row.style.display = showRow ? '' : 'none';
            });
        }

        function selectAllOptions(optionsDiv, containerId, colIndex) {
            const checkboxes = optionsDiv.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            applyFilters(containerId);
        }

        function resetFilters(containerId) {
            const table = document.getElementById(containerId).querySelector('table');
            if (table) {
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => row.style.display = '');
                delete filters[containerId];
            }
        }

        document.addEventListener('click', function (event) {
            const dropdowns = document.querySelectorAll('.filter-dropdown-content');
            dropdowns.forEach(dropdown => {
                if (!dropdown.parentElement.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });
        });

        // Mobile menu functionality
        document.addEventListener('DOMContentLoaded', function() {
            const menuBtn = document.querySelector('.mobile-menu-btn');
            const container = document.querySelector('.container');
            
            if (menuBtn) {
                menuBtn.addEventListener('click', function() {
                    container.classList.toggle('mobile-menu-open');
                });
            }
            
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.mobile-menu-btn') && !event.target.closest('.nav-links')) {
                    container.classList.remove('mobile-menu-open');
                }
            });
        });
        
      
         //         }   else      {       alert("This GST Reconciliation tool is fully secured by Sumit Garg. If not working or face any problem in accessing then contact to me. Name - Sumit Garg, Ph. No. - 9716804520, Email - SumitGarg100000@Gmail.com ");     } 
        
        
    </script>
</body>
</html>
