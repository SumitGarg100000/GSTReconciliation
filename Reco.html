<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GST Reconciliation Tool - Professional Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', Arial, sans-serif;
        }

        :root {
            --primary-color: #1a73e8;
            --primary-dark: #0d47a1;
            --text-primary: #333333;
            --text-secondary: #666666;
            --bg-gradient-1: linear-gradient(135deg, #f5f7fa, #e4f1ff);
        }

        body {
            background: var(--bg-gradient-1);
            color: var(--text-primary);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 61, 115, 0.1);
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 8px;
            background: linear-gradient(135deg, #1a73e8, #0d47a1);
        }

        .header-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-dark);
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .logo i {
            margin-right: 10px;
            color: var(--primary-color);
        }

        .nav-links {
            display: flex;
        }

        .nav-links a {
            margin-left: 25px;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-links a:hover {
            color: var(--primary-color);
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .nav-links a:hover::after {
            width: 100%;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--primary-dark);
            cursor: pointer;
        }

        /* Tool Specific Styles */
        .gst-container {
            max-width: 100%;
            width: 98%;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 61, 115, 0.1);
            min-height: calc(80vh - 40px);
            display: flex;
            flex-direction: column;
        }

        h1 {
            text-align: center;
            color: #0e4377;
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        h2 {
            text-align: center;
            color: #1a5fb4;
            font-size: 1.8em;
            margin: 20px 0;
            padding: 10px;
            background: linear-gradient(to right, #e6f3ff, #f0f8ff);
            border-radius: 8px;
        }

        .control-panel {
            background: #f5f9ff;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 10px rgba(0, 61, 115, 0.05);
        }

        .options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #e6f3ff;
            border-radius: 10px;
            border: 1px solid #cce0ff;
        }

        .option-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .button-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        button:active {
            transform: translateY(1px);
        }

        #reconcile-btn {
            background: linear-gradient(145deg, #1a73e8, #0d47a1);
            color: white;
        }

        #reconcile-btn:hover {
            background: linear-gradient(145deg, #0d47a1, #1a73e8);
        }

        #reset-btn {
            background: linear-gradient(145deg, #e53935, #c62828);
            color: white;
        }

        #reset-btn:hover {
            background: linear-gradient(145deg, #c62828, #e53935);
        }

        #download-sample {
            background: linear-gradient(145deg, #2e7d32, #1b5e20);
            color: white;
        }

        #download-sample:hover {
            background: linear-gradient(145deg, #1b5e20, #2e7d32);
        }

        .upload-section {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 10px;
            border: 1px dashed #1a73e8;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            background: #e6f3ff;
            border-color: #0d47a1;
        }

        input[type="file"] {
            padding: 10px;
            border: 2px solid #1a73e8;
            border-radius: 8px;
            background: #f5f9ff;
            width: 100%;
            transition: border-color 0.3s;
        }

        input[type="file"]:hover {
            border-color: #0d47a1;
        }

        input[type="number"], input[type="checkbox"], input[type="text"], input[type="password"], input[type="email"] {
            padding: 10px;
            border: 2px solid #1a73e8;
            border-radius: 8px;
            background: #f5f9ff;
            transition: all 0.3s ease;
        }

        input[type="number"]:focus, input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus {
            border-color: #0d47a1;
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #1a73e8;
        }

        label {
            font-weight: 600;
            color: #0e4377;
        }

        .data-container {
            margin: 30px 0;
        }

        .table-container {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 600px;
            margin: 15px 0;
            border: 1px solid #cce0ff;
            border-radius: 8px;
            padding: 5px;
            background: #f5f9ff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        /* Virtual Scrolling Styles */
        .virtual-table-container {
            position: relative;
            height: 600px;
            overflow: auto;
        }

        .virtual-table-content {
            position: relative;
        }

        .virtual-row {
            position: absolute;
            width: 100%;
            left: 0;
            border-bottom: 1px solid #cce0ff;
            display: flex;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        table thead th {
            position: sticky;
            top: 0;
            background: #1a73e8;
            color: white;
            z-index: 10;
            border-bottom: 1px solid #0d47a1;
            padding: 12px;
            text-align: left;
        }

        th {
            background: #1a73e8;
            color: white;
            font-weight: bold;
            padding: 12px;
            text-align: left;
        }

        td {
            border: 1px solid #cce0ff;
            padding: 10px;
            text-align: left;
        }

        tr:nth-child(even) td {
            background-color: #f9f9f9;
        }

        #login-section.hidden, #tool-section.hidden {
            display: none;
        }

        #error {
            color: #e53935;
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
        }

        #expiry-message {
            font-size: 1.2em;
            margin: 10px 0;
            padding: 10px;
            background: #ffebee;
            border-left: 4px solid #e53935;
            border-radius: 4px;
            transition: opacity 0.5s ease;
            color: #e53935;
        }

        .email-section {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 10px;
            border: 1px dashed #1a73e8;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .email-section:hover {
            background: #e6f3ff;
            border-color: #0d47a1;
        }

        #send-email-btn:hover {
            background: linear-gradient(145deg, #f57c00, #ff9800);
        }

        #email-error {
            color: #e53935;
            font-weight: 600;
        }

        a#download-output {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 25px;
            background: linear-gradient(145deg, #1a73e8, #0d47a1);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-decoration: none;
            margin: 20px auto;
            text-align: center;
        }

        a#download-output:hover {
            background: linear-gradient(145deg, #0d47a1, #1a73e8);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #1a73e8, #0d47a1);
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1a73e8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Batch Processing Status */
        .batch-status {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #1a73e8;
            display: none;
        }

        .batch-status.processing {
            display: block;
        }

        /* Custom Dropdown Styles */
        .custom-select {
            position: relative;
            display: inline-block;
            min-width: 150px;
            margin: 0 10px;
        }

        .custom-select select {
            appearance: none;
            -webkit-appearance: none;
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #1a73e8;
            border-radius: 8px;
            background-color: #f5f9ff;
            color: #0e4377;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .custom-select select:hover {
            border-color: #0d47a1;
            background-color: #e6f3ff;
        }

        .custom-select select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
        }

        .custom-select::after {
            content: "\25BC";
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            color: #1a73e8;
            pointer-events: none;
        }

        /* WhatsApp & Instructions Buttons */
        .whatsapp-btn, .instructions-btn {
            position: fixed;
            z-index: 1000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            box-shadow: 0 0 20px 10px rgba(37, 211, 102, 0.1);
            animation: glow 3s infinite;
            transition: all 0.3s ease;
        }

        .whatsapp-btn {
            bottom: 20px;
            right: 20px;
            background: linear-gradient(145deg, #25d366, #128C7E);
            color: white;
            width: 70px;
            height: 70px;
        }

        .instructions-btn {
            bottom: 100px;
            right: 20px;
            background: linear-gradient(145deg, #1a73e8, #0d47a1);
            color: white;
            width: 70px;
            height: 70px;
            border: none;
            cursor: pointer;
        }

        .whatsapp-btn:hover, .instructions-btn:hover {
            transform: scale(1.1);
            animation-play-state: paused;
        }

        .whatsapp-btn i, .instructions-btn i {
            font-size: 36px;
        }

        @keyframes glow {
            0% { box-shadow: 0 0 20px 0px rgba(26, 115, 232, 0.2); transform: scale(1); }
            50% { box-shadow: 0 0 40px 20px rgba(26, 115, 232, 0.1); transform: scale(1.05); }
            100% { box-shadow: 0 0 20px 0px rgba(26, 115, 232, 0.2); transform: scale(1); }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 25px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            color: #0e4377;
            cursor: pointer;
            border: none;
            background: none;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #e53935;
        }

        /* Footer Styles */
        footer {
            background: linear-gradient(145deg, #0e4377, #1a5fb4);
            color: #ffffff;
            padding: 1.5rem;
            border-radius: 10px;
            margin-top: 30px;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05);
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .footer-links a {
            color: #ffffff;
            text-decoration: none;
            opacity: 0.9;
            transition: opacity 0.3s ease;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .footer-links a:hover {
            opacity: 1;
            text-decoration: underline;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .nav-links {
                display: none;
            }

            .mobile-menu-btn {
                display: block;
            }

            .mobile-menu-open .nav-links {
                display: flex;
                flex-direction: column;
                position: absolute;
                top: 70px;
                right: 20px;
                background: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
                z-index: 100;
            }

            .mobile-menu-open .nav-links a {
                margin: 10px 0;
            }

            .options-container {
                flex-direction: column;
            }

            .button-container {
                flex-direction: column;
            }

            button {
                width: 100%;
            }

            .gst-container {
                width: 100%;
                min-height: calc(100vh - 60px);
                padding: 15px;
            }

            h1 {
                font-size: 2em;
            }

            .modal-content {
                width: 95%;
                padding: 15px;
            }

            .footer-links {
                flex-direction: column;
                gap: 10px;
            }

            .custom-select {
                width: 100%;
                margin: 10px 0;
            }

            .email-section .flex {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header-nav">
            <a href="#" class="logo">
                <i class="fas fa-chart-line"></i>
                <span>Sumit Garg</span>
            </a>
            <div class="nav-links">
                <a href="#">Home</a>
                <a href="#">Services</a>
                <a href="#">About</a>
                <a href="#">Contact</a>
            </div>
            <button class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
        </header>

        <div id="gst-reconcilation">
            <div class="gst-container">
                <!-- Login Section -->
                <div id="login-section">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold">GST Reconciliation Login</h1>
                        <button onclick="goToHomepage()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                            <i class="fas fa-home"></i> Back to Homepage
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <label for="username" class="block mb-2">Username:</label>
                        <input type="text" id="username" value="" placeholder="Enter username" class="w-full">
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block mb-2">Password:</label>
                        <input type="password" id="password" value="" placeholder="Enter password" class="w-full">
                    </div>
                    <div class="flex flex-wrap justify-center gap-4">
                        <button onclick="login()" style="background: linear-gradient(145deg, #1a73e8, #0d47a1); color: white;" class="flex-1">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                        <button onclick="freeServiceLogin()" style="background: linear-gradient(145deg, #ff9800, #f57c00); color: white;" class="flex-1">
                            <i class="fas fa-user-check"></i> Free Service Login
                        </button>
                    </div>
                    <p id="error" class="mt-4"></p>

                    <div class="explanation" id="explanation-container">
                        <!-- Blank as requested -->
                    </div>
                </div>

                <!-- Tool Section -->
                <div id="tool-section" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h1>GST Reconciliation Tool</h1>
                        <button onclick="logout()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                    <p id="expiry-message" style="display: none;" class="text-center"></p>
                    
                    <div class="control-panel">
                        <!-- Sample Download Button -->
                        <div class="button-container">
                            <button id="download-sample" class="bg-green-600 hover:bg-green-700">
                                <i class="fas fa-file-download"></i> Download Sample Excel File
                            </button>
                        </div>
                        
                        <!-- Options Container -->
                        <div class="options-container">
                            <div class="option-group">
                                <label for="diff-allowed">Difference Allowed:</label>
                                <input type="number" id="diff-allowed" value="1" min="0" class="w-20" placeholder="0 if blank">
                                <span class="text-sm text-gray-600">(Default: 1)</span>
                            </div>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="detailed-reconciliation" name="detailed-reconciliation">
                                <label for="detailed-reconciliation">Detailed Reconciliation</label>
                            </div>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="enable-filter" name="enable-filter">
                                <label for="enable-filter">Enable Filters</label>
                            </div>
                        </div>
                        
                        <!-- Upload Section -->
                        <div class="upload-section">
                            <label for="gst-file" class="block mb-2">
                                <i class="fas fa-file-upload mr-2"></i>Upload GST Data File (GSTR-2B & GSTR-3B):
                            </label>
                            <input type="file" id="gst-file" accept=".xlsx" class="block w-full">
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="progress-container" id="progress-container">
                            <div class="progress-bar" id="progress-bar">
                                <div class="progress-text" id="progress-text">0%</div>
                            </div>
                        </div>

                        <!-- Batch Status -->
                        <div class="batch-status" id="batch-status">
                            <div class="flex items-center gap-2">
                                <div class="loading-spinner" style="display: inline-block; width: 20px; height: 20px;"></div>
                                <span id="batch-status-text">Processing batch 1 of 10...</span>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="button-container">
                            <button id="reconcile-btn">
                                <i class="fas fa-sync-alt"></i> Reconcile
                            </button>
                            <button id="reset-btn">
                                <i class="fas fa-trash-alt"></i> Reset Data
                            </button>
                        </div>

                        <!-- Email Section -->
                        <div class="email-section">
                            <h3 class="text-lg font-bold mb-2">Email Reconciliation Results</h3>
                            <div class="flex flex-wrap gap-4 mb-4 items-center">
                                <div class="flex-1">
                                    <label for="sender-email" class="block mb-2">Sender Email:</label>
                                    <input type="email" id="sender-email" placeholder="Enter sender email" class="w-full" required>
                                </div>
                                <div class="flex-1">
                                    <label for="receiver-email" class="block mb-2">Receiver Email:</label>
                                    <input type="email" id="receiver-email" placeholder="Enter receiver email" class="w-full" required>
                                </div>
                            </div>

                            <div class="flex items-center justify-center gap-4 flex-wrap">
                                <div class="custom-select">
                                    <label for="entry-filter" class="block mb-2">Filter Entries:</label>
                                    <select id="entry-filter">
                                        <option value="all">All Entries</option>
                                        <option value="match">Match Only</option>
                                        <option value="unmatch">Unmatch Only</option>
                                    </select>
                                </div>
                                <button id="send-email-btn" style="background: linear-gradient(145deg, #ff9800, #f57c00); color: white; margin-top: 25px;">
                                    <i class="fas fa-envelope"></i> Send Email
                                </button>
                                <div class="custom-select">
                                    <label for="export-format" class="block mb-2">Export Format:</label>
                                    <select id="export-format">
                                        <option value="excel">Excel</option>
                                        <option value="pdf">PDF</option>
                                        <option value="both">Both</option>
                                    </select>
                                </div>
                            </div>
                            <p id="email-error" class="text-red-600 text-center mt-2 hidden"></p>
                            <p style="color: red; text-align: center; margin-top: 10px;">
                                Email function is pending due to ongoing improvements and suggestions.
                            </p>
                        </div>
                    </div>
                    
                    <div class="data-container">
                        <h2>GSTR-2B Data</h2>
                        <div id="gstr2b-container" class="table-container"></div>
                        
                        <h2>Client Data</h2>
                        <div id="gstr3b-container" class="table-container"></div>
                        
                        <h2>Summary</h2>
                        <div id="summary-container" class="table-container"></div>
                    </div>
                    
                    <div id="output-link" style="display: none;" class="text-center">
                        <h3 class="text-xl font-bold text-blue-800 mb-4">Reconciled Output:</h3>
                        <a id="download-output" href="#" class="inline-block">
                            <i class="fas fa-file-excel mr-2"></i> Download Reconciled Data
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="instructions-btn" onclick="showInstructions()" aria-label="View Instructions">
        <i class="fas fa-info-circle"></i>
    </button>
    
    <a href="https://wa.me/9716804520" class="whatsapp-btn" target="_blank" rel="noopener noreferrer" aria-label="Chat on WhatsApp">
        <i class="fab fa-whatsapp"></i>
    </a>
    
    <div id="instructions-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="hideInstructions()">×</span>
            <!-- Blank as requested -->
        </div>
    </div>
    
    <footer>
        <div class="footer-content">
            <div class="footer-links">
                <a href="#"><i class="fas fa-phone mr-2"></i> Ph: 9716804520</a>
                <a href="#"><i class="fas fa-envelope mr-2"></i> Email: Sumitgarg100000@gmail.com</a>
                <a href="#"><i class="fas fa-map-marker-alt mr-2"></i> Address: Rohini, Delhi-110086</a>
            </div>
            <div class="footer-links">
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.29.3/date-fns.min.js"></script>

    <script>
        // Performance optimizations and configuration
        const BATCH_SIZE = 500; // Process 500 records at a time
        const VIRTUAL_ROW_HEIGHT = 40; // Height of each row in virtual scrolling
        const STORAGE_DELAY = 10000; // 10 seconds delay for storage
        const MAX_VISIBLE_ROWS = 50; // Maximum rows to render at once

        // Global variables (keeping original names as requested)
        const users = {
            "Sumitgarg": { password: "Garg@123", expiry: "2026-04-30"},
            "user1": { password: "pass123", expiry: "2025-04-30" },
            "user2": { password: "pass456", expiry: "2025-05-15" }
        };

        let gstr2bData = [];
        let gstr3bData = [];
        let processedBatches = 0;
        let totalBatches = 0;
        let isProcessing = false;
        let storageTimeout = null;
        let virtualScrollOffset = 0;

        const detailedReconciliationCheckbox = document.getElementById('detailed-reconciliation');

        // Enhanced storage with delay
        function delayedStorage(key, data) {
            if (storageTimeout) {
                clearTimeout(storageTimeout);
            }
            
            storageTimeout = setTimeout(() => {
                try {
                    // Check if data size is too large for localStorage
                    const serialized = JSON.stringify(data);
                    if (serialized.length > 5000000) { // 5MB limit
                        console.warn('Data too large for localStorage, using sessionStorage');
                        sessionStorage.setItem(key, serialized);
                    } else {
                        localStorage.setItem(key, serialized);
                    }
                } catch (e) {
                    console.warn('Storage failed, data too large:', e);
                    // Fallback to memory only
                }
            }, STORAGE_DELAY);
        }

        // Enhanced data loading with fallback
        function loadStoredData(key) {
            try {
                return JSON.parse(localStorage.getItem(key) || sessionStorage.getItem(key) || '[]');
            } catch (e) {
                console.warn('Failed to load stored data:', e);
                return [];
            }
        }

        // Initialize on page load
        document.addEventListener("DOMContentLoaded", function() {
            const loggedInUser = localStorage.getItem("loggedInUser");
            const isFreeService = localStorage.getItem("isFreeService") === "true";

            // Load stored data
            gstr2bData = loadStoredData('gstr2bData');
            gstr3bData = loadStoredData('gstr3bData');

            // Restore email fields from localStorage
            const senderEmail = localStorage.getItem('senderEmail');
            const receiverEmail = localStorage.getItem('receiverEmail');
            if (senderEmail) {
                document.getElementById('sender-email').value = senderEmail;
            }
            if (receiverEmail) {
                document.getElementById('receiver-email').value = receiverEmail;
            }

            if (loggedInUser) {
                if (isFreeService) {
                    showTool();
                    restrictFreeServiceFeatures();
                } else if (checkSubscription(loggedInUser)) {
                    showTool();
                } else {
                    showLogin();
                }
            } else {
                showLogin();
            }
        });

        // Progress bar management
        function updateProgress(current, total, text = '') {
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            const percentage = Math.round((current / total) * 100);
            
            if (current === 0) {
                progressContainer.style.display = 'block';
            }
            
            progressBar.style.width = percentage + '%';
            progressText.textContent = text || `${percentage}%`;
            
            if (current >= total) {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 1000);
            }
        }

        // Batch status management
        function updateBatchStatus(current, total, isVisible = true) {
            const batchStatus = document.getElementById('batch-status');
            const batchText = document.getElementById('batch-status-text');
            
            if (isVisible && current > 0) {
                batchStatus.classList.add('processing');
                batchText.textContent = `Processing batch ${current} of ${total}...`;
            } else {
                batchStatus.classList.remove('processing');
            }
        }

        // Enhanced login function
        function login() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const error = document.getElementById("error");

            if (users[username] && users[username].password === password) {
                if (checkSubscription(username)) {
                    localStorage.setItem("loggedInUser", username);
                    localStorage.setItem("isFreeService", "false");
                    clearEmailFields();
                    showTool();
                    showExpiryMessage(users[username].expiry);
                    clearLoginFields();
                } else {
                    error.textContent = "Your subscription has expired!";
                }
            } else {
                error.textContent = "Invalid username or password!";
            }
        }

        function freeServiceLogin() {
            localStorage.setItem("loggedInUser", "freeServiceUser");
            localStorage.setItem("isFreeService", "true");
            clearEmailFields();
            showTool();
            restrictFreeServiceFeatures();
            clearLoginFields();
        }

        function clearEmailFields() {
            document.getElementById('sender-email').value = '';
            document.getElementById('receiver-email').value = '';
            localStorage.removeItem('senderEmail');
            localStorage.removeItem('receiverEmail');
        }

        function clearLoginFields() {
            document.getElementById("username").value = "";
            document.getElementById("password").value = "";
            document.getElementById("error").textContent = "";
        }

        function showExpiryMessage(expiry) {
            const expiryMessage = document.getElementById("expiry-message");
            if (expiryMessage) {
                expiryMessage.textContent = `Subscription Expiry: ${expiry}`;
                expiryMessage.style.display = "block";
                expiryMessage.style.opacity = "1";

                setTimeout(() => {
                    expiryMessage.style.opacity = "0";
                    setTimeout(() => {
                        expiryMessage.style.display = "none";
                        expiryMessage.style.opacity = "1";
                    }, 500);
                }, 10000);
            }
        }

        function checkSubscription(username) {
            const expiryDate = new Date(users[username].expiry);
            const today = new Date();
            return today <= expiryDate;
        }

        function logout() {
            localStorage.removeItem("loggedInUser");
            localStorage.removeItem("gstr2bData");
            localStorage.removeItem("gstr3bData");
            localStorage.removeItem("isFreeService");
            gstr2bData = [];
            gstr3bData = [];
            resetData();
            showLogin();
            clearLoginFields();
        }

        function goToHomepage() {
            window.location.href = 'https://sumitgarg100000.github.io/Home/';
        }

        function showLogin() {
            document.getElementById("login-section").classList.remove("hidden");
            document.getElementById("tool-section").classList.add("hidden");
        }

        function showTool() {
            document.getElementById("login-section").classList.add("hidden");
            document.getElementById("tool-section").classList.remove("hidden");

            const isFreeService = localStorage.getItem("isFreeService") === "true";
            const detailedReconciliationCheckbox = document.getElementById("detailed-reconciliation");
            detailedReconciliationCheckbox.checked = localStorage.getItem('detailedReconciliation') === 'true' && !isFreeService;

            setupEventListeners();
            restoreData();
            restrictFreeServiceFeatures();
        }

        function setupEventListeners() {
            const reconcileBtn = document.getElementById('reconcile-btn');
            const downloadSample = document.getElementById('download-sample');
            const diffAllowed = document.getElementById('diff-allowed');
            const resetBtn = document.getElementById('reset-btn');
            const gstFile = document.getElementById('gst-file');

            // Remove existing listeners to avoid duplicates
            reconcileBtn.removeEventListener('click', reconcileDataAsync);
            downloadSample.removeEventListener('click', generateSampleFile);
            diffAllowed.removeEventListener('input', reconcileDataAsync);
            resetBtn.removeEventListener('click', resetData);
            gstFile.removeEventListener('change', handleFileUploadAsync);

            // Add new listeners
            gstFile.addEventListener('change', handleFileUploadAsync);
            reconcileBtn.addEventListener('click', reconcileDataAsync);
            downloadSample.addEventListener('click', generateSampleFile);
            diffAllowed.addEventListener('input', debounce(reconcileDataAsync, 500));
            resetBtn.addEventListener('click', resetData);

            detailedReconciliationCheckbox.removeEventListener('change', handleCheckboxChange);
            detailedReconciliationCheckbox.addEventListener('change', handleCheckboxChange);

            function handleCheckboxChange() {
                reconcileDataAsync();
                localStorage.setItem('detailedReconciliation', detailedReconciliationCheckbox.checked);
            }

            // Save email fields to localStorage on input
            document.getElementById('sender-email').addEventListener('input', function() {
                localStorage.setItem('senderEmail', this.value);
            });

            document.getElementById('receiver-email').addEventListener('input', function() {
                localStorage.setItem('receiverEmail', this.value);
            });
        }

        function restoreData() {
            if (gstr2bData.length > 0) {
                displayDataVirtual(gstr2bData, 'gstr2b-container', gstr2bHeaders(), 'gstr2b');
            }
            if (gstr3bData.length > 0) {
                displayDataVirtual(gstr3bData, 'gstr3b-container', gstr3bHeaders(), 'gstr3b');
            }
            if (gstr2bData.length > 0 || gstr3bData.length > 0) {
                reconcileDataAsync();
            }
        }

        function restrictFreeServiceFeatures() {
            const isFreeService = localStorage.getItem("isFreeService") === "true";

            if (isFreeService) {
                const detailedCheckbox = document.getElementById("detailed-reconciliation");
                detailedCheckbox.checked = false;
                detailedCheckbox.disabled = true;

                const filterCheckbox = document.getElementById("enable-filter");
                filterCheckbox.checked = false;
                filterCheckbox.disabled = true;

                const diffAllowedInput = document.getElementById("diff-allowed");
                diffAllowedInput.value = "1";
                diffAllowedInput.disabled = true;

                disableTableEditing();
                addFreeServiceNotice();
            }
        }

        function disableTableEditing() {
            const tables = document.querySelectorAll("#gstr2b-container table, #gstr3b-container table");
            tables.forEach(table => {
                const rows = table.querySelectorAll("tbody tr");
                rows.forEach(row => {
                    const cells = row.querySelectorAll("td");
                    cells.forEach(cell => {
                        cell.setAttribute("contenteditable", "false");
                    });
                });
            });
        }

        function addFreeServiceNotice() {
            const toolSection = document.getElementById("tool-section");
            const notice = document.createElement("p");
            notice.id = "free-service-notice";
            notice.className = "bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded";
            notice.textContent = "In Free Service: Detailed Reconciliation feature, Enable Filter & sorting option, alteration of Difference Allowed limit and facility of editable fields are disabled.";
            
            if (!document.getElementById("free-service-notice")) {
                toolSection.insertBefore(notice, toolSection.querySelector(".control-panel"));
            }
        }

        function resetData() {
            gstr2bData = [];
            gstr3bData = [];
            localStorage.removeItem('gstr2bData');
            localStorage.removeItem('gstr3bData');
            localStorage.setItem('detailedReconciliation', false);
            
            document.getElementById('gstr2b-container').innerHTML = '';
            document.getElementById('gstr3b-container').innerHTML = '';
            document.getElementById('summary-container').innerHTML = '';
            document.getElementById('output-link').style.display = 'none';
            document.getElementById('gst-file').value = '';
            document.getElementById('diff-allowed').value = '1';
            
            clearEmailFields();
            
            // Hide progress indicators
            document.getElementById('progress-container').style.display = 'none';
            document.getElementById('batch-status').classList.remove('processing');
        }

        // Enhanced date parsing function
        function parseAndFormatDate(dateInput) {
            if (!dateInput || dateInput === '') return '';

            function formatDate(date) {
                const day = String(date.getDate()).padStart(2, '0');
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const month = monthNames[date.getMonth()];
                const year = date.getFullYear();
                return `${day}-${month}-${year}`;
            }

            if (typeof dateInput === 'number' && dateInput > 40000 && dateInput < 50000) {
                const excelEpoch = new Date(1899, 11, 30);
                const days = Math.floor(dateInput);
                const milliseconds = Math.round((dateInput - days) * 86400 * 1000);
                const date = new Date(excelEpoch.getTime() + days * 86400 * 1000 + milliseconds);
                if (dateInput <= 60) {
                    date.setDate(date.getDate() - 1);
                }
                return formatDate(date);
            }

            if (typeof dateInput === 'string') {
                const normalizedInput = dateInput.trim().replace(/[\.\/]/g, '-');
                let date;
                
                const mmmRegex = /^(\d{1,2})-([A-Za-z]{3})-(\d{2,4})$/;
                if (mmmRegex.test(normalizedInput)) {
                    const [, day, monthStr, year] = normalizedInput.match(mmmRegex);
                    const monthNames = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                    const monthIndex = monthNames.indexOf(monthStr.toLowerCase());
                    if (monthIndex !== -1) {
                        const fullYear = year.length === 2 ? (parseInt(year) < 50 ? `20${year}` : `19${year}`) : year;
                        date = new Date(parseInt(fullYear), monthIndex, parseInt(day));
                    }
                }

                if (!date || isNaN(date.getTime())) {
                    const dmyRegex = /^(\d{1,2})-(\d{1,2})-(\d{2,4})$/;
                    if (dmyRegex.test(normalizedInput)) {
                        const [, day, month, year] = normalizedInput.match(dmyRegex);
                        const fullYear = year.length === 2 ? (parseInt(year) < 50 ? `20${year}` : `19${year}`) : year;
                        date = new Date(parseInt(fullYear), parseInt(month) - 1, parseInt(day));
                    }
                }

                if (!date || isNaN(date.getTime())) {
                    date = new Date(normalizedInput);
                }

                if (date && !isNaN(date.getTime())) {
                    return formatDate(date);
                }

                console.warn(`Invalid date format: ${dateInput}`);
                return '';
            }

            if (dateInput instanceof Date && !isNaN(dateInput.getTime())) {
                return formatDate(dateInput);
            }

            console.warn(`Unrecognized date input: ${dateInput}`);
            return '';
        }

        function formatDate(dateInput) {
            return parseAndFormatDate(dateInput);
        }

        // Header definitions
        const baseGstr2bHeaders = ['Match Criteria', 'GSTN', 'Name of Supplier', 'Invoice Number', 'Invoice type', 'Invoice Date', 'Invoice Value', 'Place of supply', 'Reverse Charge', 'Rate (%)', 'Taxable Value', 'IGST', 'CGST', 'SGST'];
        const extendedGstr2bHeaders = ['Cess', 'GSTR-1/5 Period', 'GSTR-1/5 Filing Date', 'ITC Availability', 'Reason', 'Applicable % of Tax Rate', 'Source', 'IRN', 'IRN Date'];
        function gstr2bHeaders() { return [...baseGstr2bHeaders, ...extendedGstr2bHeaders]; }

        const baseGstr3bHeaders = ['Match Criteria', 'Invoice Date', 'GSTN', 'Name of Supplier', 'Invoice Number', 'Taxable Value', 'IGST', 'CGST', 'SGST', 'CESS'];
        const extendedGstr3bHeaders = ['Invoice Value'];
        function gstr3bHeaders() { return [...baseGstr3bHeaders, ...extendedGstr3bHeaders]; }

        // Enhanced sample file generation (with blank data as requested)
        function generateSampleFile(event) {
            event.preventDefault();
            const wb = XLSX.utils.book_new();
            
            // Create blank sample with headers only
            const gstr2bSampleHeaders = gstr2bHeaders();
            const gstr2bSample = [gstr2bSampleHeaders];
            const ws1 = XLSX.utils.aoa_to_sheet(gstr2bSample);
            gstr2bSampleHeaders.forEach((_, index) => {
                const cell = ws1[XLSX.utils.encode_cell({ r: 0, c: index })];
                if (cell) cell.s = { fill: { fgColor: { rgb: 'E0FFFF' } } };
            });
            XLSX.utils.book_append_sheet(wb, ws1, 'GST Portal');

            const gstr3bSampleHeaders = gstr3bHeaders();
            const gstr3bSample = [gstr3bSampleHeaders];
            const ws2 = XLSX.utils.aoa_to_sheet(gstr3bSample);
            gstr3bSampleHeaders.forEach((_, index) => {
                const cell = ws2[XLSX.utils.encode_cell({ r: 0, c: index })];
                if (cell) cell.s = { fill: { fgColor: { rgb: 'E0FFFF' } } };
            });
            XLSX.utils.book_append_sheet(wb, ws2, 'Client Data');

            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'Sample_GST_Reconciliation.xlsx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function normalizeRow(row, headerLength) {
            const normalized = new Array(headerLength).fill('');
            row.forEach((cell, index) => {
                if (index < headerLength) normalized[index] = cell === undefined || cell === null ? '' : cell;
            });
            return normalized;
        }

        // Enhanced file upload with async processing
        async function handleFileUploadAsync(event) {
            if (isProcessing) {
                alert('Please wait for current processing to complete.');
                return;
            }

            const file = event.target.files[0];
            if (!file) return;

            isProcessing = true;
            updateProgress(0, 100, 'Reading file...');

            try {
                const data = await readFileAsync(file);
                const workbook = XLSX.read(data, { type: 'array', dateNF: 'dd-mmm-yyyy', raw: true });
                
                await processWorkbookAsync(workbook);
                
                updateProgress(100, 100, 'Complete!');
                await reconcileDataAsync();
            } catch (error) {
                console.error('File upload error:', error);
                alert('Error processing file. Please check the file format.');
            } finally {
                isProcessing = false;
            }
        }

        function readFileAsync(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve(new Uint8Array(e.target.result));
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        async function processWorkbookAsync(workbook) {
            updateProgress(20, 100, 'Processing GSTR-2B data...');
            
            // Process GSTR-2B Data
            const gstr2bSheet = workbook.Sheets['GST Portal'];
            if (gstr2bSheet) {
                const rawData = XLSX.utils.sheet_to_json(gstr2bSheet, { header: 1, defval: '' });
                await processDataInBatches(rawData.slice(1), gstr2bHeaders(), true);
            }

            updateProgress(60, 100, 'Processing GSTR-3B data...');
            
            // Process GSTR-3B Data
            const gstr3bSheet = workbook.Sheets['Client Data'];
            if (gstr3bSheet) {
                const rawData = XLSX.utils.sheet_to_json(gstr3bSheet, { header: 1, defval: '' });
                await processDataInBatches(rawData.slice(1), gstr3bHeaders(), false);
            }

            updateProgress(90, 100, 'Storing data...');
            
            // Store data with delay
            delayedStorage('gstr2bData', gstr2bData);
            delayedStorage('gstr3bData', gstr3bData);
        }

        async function processDataInBatches(rawData, headers, isGstr2b) {
            const totalRows = rawData.length;
            totalBatches = Math.ceil(totalRows / BATCH_SIZE);
            processedBatches = 0;

            if (totalRows > BATCH_SIZE) {
                updateBatchStatus(1, totalBatches, true);
            }

            const processedData = [];

            for (let i = 0; i < totalRows; i += BATCH_SIZE) {
                const batch = rawData.slice(i, i + BATCH_SIZE);
                processedBatches++;
                
                updateBatchStatus(processedBatches, totalBatches, totalRows > BATCH_SIZE);
                
                // Process batch
                const batchProcessed = batch.map(row => {
                    const normalized = normalizeRow(row, headers.length);
                    // Convert date columns
                    const dateIndices = isGstr2b ? 
                        [headers.indexOf('Invoice Date'), headers.indexOf('GSTR-1/5 Filing Date'), headers.indexOf('IRN Date')] :
                        [headers.indexOf('Invoice Date')];
                    
                    dateIndices.forEach(idx => {
                        if (idx !== -1 && normalized[idx] !== '') {
                            normalized[idx] = parseAndFormatDate(normalized[idx]);
                        }
                    });
                    return normalized;
                });

                processedData.push(...batchProcessed);

                // Allow UI to update
                if (totalRows > BATCH_SIZE) {
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            }

            if (isGstr2b) {
                gstr2bData = processedData;
                displayDataVirtual(gstr2bData, 'gstr2b-container', headers, 'gstr2b');
            } else {
                gstr3bData = processedData;
                displayDataVirtual(gstr3bData, 'gstr3b-container', headers, 'gstr3b');
            }

            updateBatchStatus(0, 0, false);
        }

        // Virtual scrolling implementation for large datasets
        function displayDataVirtual(data, containerId, headers, sheetType) {
            const container = document.getElementById(containerId);
            const isFreeService = localStorage.getItem("isFreeService") === "true";
            
            if (data.length <= MAX_VISIBLE_ROWS) {
                // Use regular table for small datasets
                displayDataRegular(data, containerId, headers, sheetType);
                return;
            }

            // Virtual scrolling for large datasets
            container.innerHTML = `
                <div class="virtual-table-container" style="height: 600px; overflow: auto;">
                    <div class="virtual-table-content">
                        <table style="position: sticky; top: 0; z-index: 10;">
                            <thead>
                                <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                            </thead>
                        </table>
                        <div class="virtual-rows" style="position: relative; height: ${data.length * VIRTUAL_ROW_HEIGHT}px;">
                        </div>
                    </div>
                </div>
            `;

            const virtualContainer = container.querySelector('.virtual-table-container');
            const virtualRows = container.querySelector('.virtual-rows');
            
            function renderVisibleRows() {
                const scrollTop = virtualContainer.scrollTop;
                const containerHeight = virtualContainer.clientHeight;
                
                const startIndex = Math.floor(scrollTop / VIRTUAL_ROW_HEIGHT);
                const endIndex = Math.min(startIndex + Math.ceil(containerHeight / VIRTUAL_ROW_HEIGHT) + 1, data.length);
                
                virtualRows.innerHTML = '';
                
                for (let i = startIndex; i < endIndex; i++) {
                    const row = data[i];
                    const rowElement = document.createElement('div');
                    rowElement.className = 'virtual-row';
                    rowElement.style.top = `${i * VIRTUAL_ROW_HEIGHT}px`;
                    rowElement.style.height = `${VIRTUAL_ROW_HEIGHT}px`;
                    rowElement.setAttribute('data-row', i);
                    rowElement.setAttribute('data-sheet', sheetType);
                    
                    let rowHtml = '';
                    headers.forEach((_, colIndex) => {
                        const cell = row[colIndex];
                        const isDateColumn = headers[colIndex] === 'Invoice Date' ||
                                            headers[colIndex] === 'GSTR-1/5 Filing Date' ||
                                            headers[colIndex] === 'IRN Date';
                        const value = isDateColumn ? parseAndFormatDate(cell) : (cell === undefined || cell === null ? '' : cell);
                        const isEditable = colIndex > 0 && !isFreeService;
                        rowHtml += `<div style="border: 1px solid #cce0ff; padding: 10px; flex: 1; min-width: 100px;" contenteditable="${isEditable}" data-col="${colIndex}">${value}</div>`;
                    });
                    
                    rowElement.innerHTML = rowHtml;
                    virtualRows.appendChild(rowElement);
                }
            }

            virtualContainer.addEventListener('scroll', debounce(renderVisibleRows, 10));
            renderVisibleRows();

            // Add event listener for cell editing
            virtualRows.addEventListener('input', handleCellEdit);
        }

        // Regular table display for smaller datasets
        function displayDataRegular(data, containerId, headers, sheetType) {
            const container = document.getElementById(containerId);
            const isFreeService = localStorage.getItem("isFreeService") === "true";
            let html = '<table><thead><tr>';
            headers.forEach(header => html += `<th>${header}</th>`);
            html += '</tr></thead><tbody>';
            data.forEach((row, rowIndex) => {
                html += `<tr data-row="${rowIndex}" data-sheet="${sheetType}">`;
                headers.forEach((_, colIndex) => {
                    const cell = row[colIndex];
                    const isDateColumn = headers[colIndex] === 'Invoice Date' ||
                                        headers[colIndex] === 'GSTR-1/5 Filing Date' ||
                                        headers[colIndex] === 'IRN Date';
                    const value = isDateColumn ? parseAndFormatDate(cell) : (cell === undefined || cell === null ? '' : cell);
                    const isEditable = colIndex > 0 && !isFreeService;
                    html += `<td contenteditable="${isEditable}" data-col="${colIndex}">${value}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
            const table = container.querySelector('table');
            table.addEventListener('input', handleCellEdit);

            if (isFreeService) {
                disableTableEditing();
            }
        }

        function handleCellEdit(event) {
            const target = event.target;
            const isFreeService = localStorage.getItem("isFreeService") === "true";

            if (isFreeService) {
                event.preventDefault();
                target.blur();
                return;
            }

            const rowElement = target.closest('[data-row]');
            if (!rowElement) return;

            const rowIndex = parseInt(rowElement.getAttribute('data-row'), 10);
            const colIndex = parseInt(target.getAttribute('data-col'), 10);
            const sheetType = rowElement.getAttribute('data-sheet');
            const headers = sheetType === 'gstr2b' ? gstr2bHeaders() : gstr3bHeaders();
            const isDateColumn = headers[colIndex] === 'Invoice Date' ||
                                headers[colIndex] === 'GSTR-1/5 Filing Date' ||
                                headers[colIndex] === 'IRN Date';
            let newValue = target.textContent.trim();
            
            if (isDateColumn && newValue !== '') {
                newValue = parseAndFormatDate(newValue);
                target.textContent = newValue;
            }

            if (sheetType === 'gstr2b') {
                gstr2bData[rowIndex][colIndex] = newValue;
                delayedStorage('gstr2bData', gstr2bData);
            } else if (sheetType === 'gstr3b') {
                gstr3bData[rowIndex][colIndex] = newValue;
                delayedStorage('gstr3bData', gstr3bData);
            }
            
            debounce(reconcileDataAsync, 1000)();
        }

        // Enhanced reconciliation with async processing
        async function reconcileDataAsync() {
            if (isProcessing) return;
            if (gstr2bData.length === 0 && gstr3bData.length === 0) return;

            isProcessing = true;
            const totalRows = gstr2bData.length + gstr3bData.length;
            
            if (totalRows > BATCH_SIZE) {
                updateProgress(0, 100, 'Starting reconciliation...');
            }

            try {
                const diffInput = document.getElementById('diff-allowed').value;
                const diffAllowed = diffInput === '' ? 0 : Number(diffInput) || 1;
                
                const reconciled2bData = await reconcileDataBatch(gstr2bData, false, diffAllowed);
                const reconciled3bData = await reconcileDataBatch(gstr3bData, true, diffAllowed);
                
                updateProgress(80, 100, 'Updating display...');
                
                updateRowColors(reconciled2bData, 'gstr2b-container');
                updateRowColors(reconciled3bData, 'gstr3b-container');
                
                displaySummary(reconciled2bData, reconciled3bData);
                
                updateProgress(90, 100, 'Generating output...');
                
                await generateOutput(reconciled2bData, reconciled3bData);
                
                updateProgress(100, 100, 'Complete!');
                
                restrictFreeServiceFeatures();
            } catch (error) {
                console.error('Reconciliation error:', error);
                alert('Error during reconciliation. Please try again.');
            } finally {
                isProcessing = false;
            }
        }

        async function reconcileDataBatch(data, is3b, diffAllowed) {
            const reconciledData = [];
            const batchSize = BATCH_SIZE;
            const totalBatches = Math.ceil(data.length / batchSize);
            let processedBatches = 0;

            for (let i = 0; i < data.length; i += batchSize) {
                const batch = data.slice(i, i + batchSize);
                processedBatches++;
                
                if (totalBatches > 1) {
                    updateProgress(Math.round((processedBatches / totalBatches) * 70), 100, `Reconciling batch ${processedBatches} of ${totalBatches}...`);
                }
                
                const batchResults = batch.map(row => {
                    const match = findMatch(row, data, is3b ? gstr2bData : gstr3bData, is3b, diffAllowed);
                    return [match, ...row.slice(1)];
                });
                
                reconciledData.push(...batchResults);
                
                // Allow UI to update
                if (totalBatches > 1) {
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            }

            return reconciledData;
        }

        function updateRowColors(reconciledData, containerId) {
            const container = document.getElementById(containerId);
            const rows = container.querySelectorAll('[data-row]');
            
            rows.forEach((row, index) => {
                if (reconciledData[index]) {
                    const match = reconciledData[index][0];
                    colorRow(row, match);
                }
            });
        }

        function normalizeInvoiceNumber(invNum) {
            return invNum.replace(/[\s\/\\.,"?\']/g, '');
        }

        function findMatch(row, sourceData, compareData, is3b, diffAllowed) {
            const sourceHeaders = is3b ? gstr3bHeaders() : gstr2bHeaders();
            const compareHeaders = is3b ? gstr2bHeaders() : gstr3bHeaders();
            const invDateIdx = sourceHeaders.indexOf('Invoice Date');
            const gstnIdx = sourceHeaders.indexOf('GSTN');
            const invNumIdx = sourceHeaders.indexOf('Invoice Number');
            const compareGstnIdx = compareHeaders.indexOf('GSTN');
            const invDate = parseAndFormatDate(row[invDateIdx]).toLowerCase().trim();
            const gstn = String(row[gstnIdx]).toLowerCase().trim();
            const invNum = normalizeInvoiceNumber(String(row[invNumIdx]).toLowerCase().trim());

            // 1. Match - GSTN, Invoice No., Date
            const sourceTotals = calculateTotals(sourceData, invDate, gstn, invNum, is3b);
            const compareTotals = calculateTotals(compareData, invDate, gstn, invNum, !is3b);
            if (sourceTotals.count > 0 && compareTotals.count > 0) {
                if (checkTotals(sourceTotals, compareTotals, diffAllowed)) {
                    return detailedReconciliationCheckbox.checked ? 'Match - GSTN, Invoice No., Date' : 'Match';
                }
            }

            // 2. Match - GSTN, Invoice No.
            const invTotals = calculateTotalsByInv(sourceData, gstn, invNum, is3b);
            const compareInvTotals = calculateTotalsByInv(compareData, gstn, invNum, !is3b);
            if (invTotals.count > 0 && compareInvTotals.count > 0) {
                if (checkTotals(invTotals, compareInvTotals, diffAllowed)) {
                    return detailedReconciliationCheckbox.checked ? 'Match - GSTN, Invoice No.' : 'Match';
                }
            }

            // 3. Match - GSTN, Date
            const gstnDateTotals = calculateTotalsByGstnDate(sourceData, invDate, gstn, is3b);
            const compareGstnDateTotals = calculateTotalsByGstnDate(compareData, invDate, gstn, !is3b);
            if (gstnDateTotals.count > 0 && compareGstnDateTotals.count > 0) {
                if (checkTotals(gstnDateTotals, compareGstnDateTotals, diffAllowed)) {
                    return detailedReconciliationCheckbox.checked ? 'Match - GSTN, Date' : 'Match';
                }
            }

            // 4. Match - GSTN
            const gstnTotals = calculateTotalsByGstn(sourceData, gstn, is3b);
            const compareGstnTotals = calculateTotalsByGstn(compareData, gstn, !is3b);
            if (gstnTotals.count > 0 && compareGstnTotals.count > 0) {
                if (checkTotals(gstnTotals, compareGstnTotals, diffAllowed)) {
                    return detailedReconciliationCheckbox.checked ? 'Match - GSTN' : 'Match';
                }
            }

            // 5. Unmatch - GSTN Not Exist
            const gstnExistsInCompare = compareData.some(r => String(r[compareGstnIdx]).toLowerCase().trim() === gstn);
            if (!gstnExistsInCompare) {
                return 'Unmatch - GSTN Not Exist';
            }

            // 6. Unmatch - Amt Diff
            const amtDiffTotals = calculateTotalsByInv(sourceData, gstn, invNum, is3b);
            const compareAmtDiffTotals = calculateTotalsByInv(compareData, gstn, invNum, !is3b);
            if (amtDiffTotals.count > 0 && compareAmtDiffTotals.count > 0) {
                if (!checkTotals(amtDiffTotals, compareAmtDiffTotals, diffAllowed)) {
                    return 'Unmatch - Amt Diff';
                }
            }

            // 7. Unmatch
            return 'Unmatch';
        }

        function calculateTotals(data, invDate, gstn, invNum, is3b) {
            const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
            const invDateIdx = headers.indexOf('Invoice Date');
            const gstnIdx = headers.indexOf('GSTN');
            const invNumIdx = headers.indexOf('Invoice Number');
            const taxableIdx = headers.indexOf('Taxable Value');
            const igstIdx = headers.indexOf('IGST');
            const cgstIdx = headers.indexOf('CGST');
            const sgstIdx = headers.indexOf('SGST');
            const cessIdx = headers.indexOf('CESS');
            let count = 0, taxable = 0, igst = 0, cgst = 0, sgst = 0, cess = 0;
            data.forEach(row => {
                const rowDate = parseAndFormatDate(row[invDateIdx]).toLowerCase().trim();
                if (rowDate === invDate && 
                    String(row[gstnIdx]).toLowerCase().trim() === gstn && 
                    normalizeInvoiceNumber(String(row[invNumIdx]).toLowerCase().trim()) === invNum) {
                    count++;
                    taxable += Number(row[taxableIdx]) || 0;
                    igst += Number(row[igstIdx]) || 0;
                    cgst += Number(row[cgstIdx]) || 0;
                    sgst += Number(row[sgstIdx]) || 0;
                    cess += Number(row[cessIdx]) || 0;
                }
            });
            return { count, taxable, igst, cgst, sgst, cess };
        }

        function calculateTotalsByInv(data, gstn, invNum, is3b) {
            const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
            const gstnIdx = headers.indexOf('GSTN');
            const invNumIdx = headers.indexOf('Invoice Number');
            const taxableIdx = headers.indexOf('Taxable Value');
            const igstIdx = headers.indexOf('IGST');
            const cgstIdx = headers.indexOf('CGST');
            const sgstIdx = headers.indexOf('SGST');
            const cessIdx = headers.indexOf('CESS');
            let count = 0, taxable = 0, igst = 0, cgst = 0, sgst = 0, cess = 0;
            data.forEach(row => {
                if (String(row[gstnIdx]).toLowerCase() === gstn && 
                    normalizeInvoiceNumber(String(row[invNumIdx]).toLowerCase()) === invNum) {
                    count++;
                    taxable += Number(row[taxableIdx]) || 0;
                    igst += Number(row[igstIdx]) || 0;
                    cgst += Number(row[cgstIdx]) || 0;
                    sgst += Number(row[sgstIdx]) || 0;
                    cess += Number(row[cessIdx]) || 0;
                }
            });
            return { count, taxable, igst, cgst, sgst, cess };
        }

        function calculateTotalsByGstnDate(data, invDate, gstn, is3b) {
            const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
            const invDateIdx = headers.indexOf('Invoice Date');
            const gstnIdx = headers.indexOf('GSTN');
            const taxableIdx = headers.indexOf('Taxable Value');
            const igstIdx = headers.indexOf('IGST');
            const cgstIdx = headers.indexOf('CGST');
            const sgstIdx = headers.indexOf('SGST');
            const cessIdx = headers.indexOf('CESS');
            let count = 0, taxable = 0, igst = 0, cgst = 0, sgst = 0, cess = 0;
            data.forEach(row => {
                const rowDate = parseAndFormatDate(row[invDateIdx]).toLowerCase().trim();
                if (rowDate === invDate && 
                    String(row[gstnIdx]).toLowerCase().trim() === gstn) {
                    count++;
                    taxable += Number(row[taxableIdx]) || 0;
                    igst += Number(row[igstIdx]) || 0;
                    cgst += Number(row[cgstIdx]) || 0;
                    sgst += Number(row[sgstIdx]) || 0;
                    cess += Number(row[cessIdx]) || 0;
                }
            });
            return { count, taxable, igst, cgst, sgst, cess };
        }

        function calculateTotalsByGstn(data, gstn, is3b) {
            const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
            const gstnIdx = headers.indexOf('GSTN');
            const taxableIdx = headers.indexOf('Taxable Value');
            const igstIdx = headers.indexOf('IGST');
            const cgstIdx = headers.indexOf('CGST');
            const sgstIdx = headers.indexOf('SGST');
            const cessIdx = headers.indexOf('CESS');
            let count = 0, taxable = 0, igst = 0, cgst = 0, sgst = 0, cess = 0;
            data.forEach(row => {
                if (String(row[gstnIdx]).toLowerCase() === gstn) {
                    count++;
                    taxable += Number(row[taxableIdx]) || 0;
                    igst += Number(row[igstIdx]) || 0;
                    cgst += Number(row[cgstIdx]) || 0;
                    sgst += Number(row[sgstIdx]) || 0;
                    cess += Number(row[cessIdx]) || 0;
                }
            });
            return { count, taxable, igst, cgst, sgst, cess };
        }

        function checkTotals(source, compare, diffAllowed) {
            return Math.abs(source.taxable - compare.taxable) <= diffAllowed &&
                   Math.abs(source.igst - compare.igst) <= diffAllowed &&
                   Math.abs(source.cgst - compare.cgst) <= diffAllowed &&
                   Math.abs(source.sgst - compare.sgst) <= diffAllowed &&
                   Math.abs(source.cess - compare.cess) <= diffAllowed;
        }

        function colorRow(rowElement, match) {
            let backgroundColor = '';
            let textColor = 'white';

            if (detailedReconciliationCheckbox.checked) {
                switch (match) {
                    case 'Match - GSTN, Invoice No., Date':
                        backgroundColor = '#00ced1';
                        break;
                    case 'Match - GSTN, Invoice No.':
                        backgroundColor = '#4b0082';
                        break;
                    case 'Match - GSTN, Date':
                        backgroundColor = '#32cd32';
                        break;
                    case 'Match - GSTN':
                        backgroundColor = '#ffbf00';
                        textColor = 'black';
                        break;
                    case 'Unmatch - GSTN Not Exist':
                        backgroundColor = '#dc143c';
                        break;
                    case 'Unmatch - Amt Diff':
                        backgroundColor = '#ff4500';
                        break;
                    default:
                        backgroundColor = '#ff00ff';
                        break;
                }
            } else {
                switch (match) {
                    case 'Match':
                        backgroundColor = '#00ced1';
                        break;
                    case 'Unmatch - GSTN Not Exist':
                        backgroundColor = '#dc143c';
                        break;
                    case 'Unmatch - Amt Diff':
                        backgroundColor = '#ff4500';
                        break;
                    default:
                        backgroundColor = '#ff00ff';
                        break;
                }
            }

            // Apply styles to all cells in the row
            const cells = rowElement.querySelectorAll('td, div[data-col]');
            cells.forEach(cell => {
                cell.style.backgroundColor = backgroundColor;
                cell.style.color = textColor;
                cell.style.fontWeight = 'normal';
            });
        }

        function calculateSummary(data, is3b) {
            const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
            const taxableIdx = headers.indexOf('Taxable Value');
            const igstIdx = headers.indexOf('IGST');
            const cgstIdx = headers.indexOf('CGST');
            const sgstIdx = headers.indexOf('SGST');
            const cessIdx = headers.indexOf('CESS');
            const criteria = detailedReconciliationCheckbox.checked ?
                ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'] :
                ['Match', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'];
            const summary = {};
            criteria.forEach(criterion => {
                summary[criterion] = { taxable: 0, igst: 0, cgst: 0, sgst: 0, cess: 0 };
            });
            data.forEach(row => {
                let match = row[0];
                if (!detailedReconciliationCheckbox.checked && 
                    ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN'].includes(match)) {
                    match = 'Match';
                }
                summary[match].taxable += Number(row[taxableIdx]) || 0;
                summary[match].igst += Number(row[igstIdx]) || 0;
                summary[match].cgst += Number(row[cgstIdx]) || 0;
                summary[match].sgst += Number(row[sgstIdx]) || 0;
                summary[match].cess += Number(row[cessIdx]) || 0;
            });
            const total = { taxable: 0, igst: 0, cgst: 0, sgst: 0, cess: 0 };
            criteria.forEach(criterion => {
                total.taxable += summary[criterion].taxable;
                total.igst += summary[criterion].igst;
                total.cgst += summary[criterion].cgst;
                total.sgst += summary[criterion].sgst;
                total.cess += summary[criterion].cess;
            });
            return { summary, total };
        }

        function displaySummary(reconciled2bData, reconciled3bData) {
            const gstr2bSummary = calculateSummary(reconciled2bData, false);
            const gstr3bSummary = calculateSummary(reconciled3bData, true);
            const container = document.getElementById('summary-container');
            let html = '<table><thead><tr>';
            html += '<th rowspan="2">Particulars</th>';
            html += '<th colspan="5">GST Portal</th>';
            html += '<th colspan="5">Client Data</th>';
            html += '</tr><tr>';
            ['Taxable Value', 'IGST', 'CGST', 'SGST', 'CESS'].forEach(header => html += `<th>${header}</th>`);
            ['Taxable Value', 'IGST', 'CGST', 'SGST', 'CESS'].forEach(header => html += `<th>${header}</th>`);
            html += '</tr></thead><tbody>';
            const criteria = detailedReconciliationCheckbox.checked ?
                ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'] :
                ['Match', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'];
            criteria.forEach(criterion => {
                let backgroundColor = '';
                let textColor = 'white';
                if (detailedReconciliationCheckbox.checked) {
                    switch (criterion) {
                        case 'Match - GSTN, Invoice No., Date':
                            backgroundColor = '#00ced1';
                            break;
                        case 'Match - GSTN, Invoice No.':
                            backgroundColor = '#4b0082';
                            break;
                        case 'Match - GSTN, Date':
                            backgroundColor = '#32cd32';
                            break;
                        case 'Match - GSTN':
                            backgroundColor = '#ffbf00';
                            textColor = 'black';
                            break;
                        case 'Unmatch - GSTN Not Exist':
                            backgroundColor = '#dc143c';
                            break;
                        case 'Unmatch - Amt Diff':
                            backgroundColor = '#ff4500';
                            break;
                        default:
                            backgroundColor = '#ff00ff';
                            break;
                    }
                } else {
                    switch (criterion) {
                        case 'Match':
                            backgroundColor = '#00ced1';
                            break;
                        case 'Unmatch - GSTN Not Exist':
                            backgroundColor = '#dc143c';
                            break;
                        case 'Unmatch - Amt Diff':
                            backgroundColor = '#ff4500';
                            break;
                        default:
                            backgroundColor = '#ff00ff';
                            break;
                    }
                }
                html += '<tr>';
                html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${criterion}</td>`;
                html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr2bSummary.summary[criterion]?.taxable || 0).toFixed(2)}</td>`;
                html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr2bSummary.summary[criterion]?.igst || 0).toFixed(2)}</td>`;
                html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr2bSummary.summary[criterion]?.cgst || 0).toFixed(2)}</td>`;
                html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr2bSummary.summary[criterion]?.sgst || 0).toFixed(2)}</td>`;
                html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr2bSummary.summary[criterion]?.cess || 0).toFixed(2)}</td>`;
                html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr3bSummary.summary[criterion]?.taxable || 0).toFixed(2)}</td>`;
                html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr3bSummary.summary[criterion]?.igst || 0).toFixed(2)}</td>`;
                html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr3bSummary.summary[criterion]?.cgst || 0).toFixed(2)}</td>`;
                html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr3bSummary.summary[criterion]?.sgst || 0).toFixed(2)}</td>`;
                html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr3bSummary.summary[criterion]?.cess || 0).toFixed(2)}</td>`;
                html += '</tr>';
            });
            html += '<tr style="font-weight: bold;">';
            html += '<td><strong>Total</strong></td>';
            html += `<td><strong>${gstr2bSummary.total.taxable.toFixed(2)}</strong></td>`;
            html += `<td><strong>${gstr2bSummary.total.igst.toFixed(2)}</strong></td>`;
            html += `<td><strong>${gstr2bSummary.total.cgst.toFixed(2)}</strong></td>`;
            html += `<td><strong>${gstr2bSummary.total.sgst.toFixed(2)}</strong></td>`;
            html += `<td><strong>${gstr2bSummary.total.cess.toFixed(2)}</strong></td>`;
            html += `<td><strong>${gstr3bSummary.total.taxable.toFixed(2)}</strong></td>`;
            html += `<td><strong>${gstr3bSummary.total.igst.toFixed(2)}</strong></td>`;
            html += `<td><strong>${gstr3bSummary.total.cgst.toFixed(2)}</strong></td>`;
            html += `<td><strong>${gstr3bSummary.total.sgst.toFixed(2)}</strong></td>`;
            html += `<td><strong>${gstr3bSummary.total.cess.toFixed(2)}</strong></td>`;
            html += '</tr>';
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function generateOutput(reconciled2bData, reconciled3bData) {
            const workbook = new ExcelJS.Workbook();
            const ws1 = workbook.addWorksheet('GST Portal');
            const headerRow1 = ws1.addRow(gstr2bHeaders());
            headerRow1.eachCell(cell => {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0FFFF' } };
            });
            reconciled2bData.forEach(row => {
                const excelRow = row.map((cell, idx) => {
                    const isDateColumn = gstr2bHeaders()[idx] === 'Invoice Date' ||
                                        gstr2bHeaders()[idx] === 'GSTR-1/5 Filing Date' ||
                                        gstr2bHeaders()[idx] === 'IRN Date';
                    return isDateColumn && cell !== '' ? parseAndFormatDate(cell) : (cell === undefined || cell === null ? '' : cell);
                });
                const addedRow = ws1.addRow(excelRow);
                applyExcelRowColor(addedRow, row[0], gstr2bHeaders().length);
            });
            const ws2 = workbook.addWorksheet('Client Data');
            const headerRow2 = ws2.addRow(gstr3bHeaders());
            headerRow2.eachCell(cell => {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0FFFF' } };
            });
            reconciled3bData.forEach(row => {
                const excelRow = row.map((cell, idx) => {
                    const isDateColumn = gstr3bHeaders()[idx] === 'Invoice Date';
                    return isDateColumn && cell !== '' ? parseAndFormatDate(cell) : (cell === undefined || cell === null ? '' : cell);
                });
                const addedRow = ws2.addRow(excelRow);
                applyExcelRowColor(addedRow, row[0], gstr3bHeaders().length);
            });

            const ws3 = workbook.addWorksheet('Summary');
            const summaryHeader1 = ws3.addRow(['Particulars', 'GST Portal', '', '', '', '', 'Client Data', '', '', '', '']);
            const summaryHeader2 = ws3.addRow(['', 'Taxable Value', 'IGST', 'CGST', 'SGST', 'CESS', 'Taxable Value', 'IGST', 'CGST', 'SGST', 'CESS']);
            ws3.mergeCells('A1:A2');
            ws3.mergeCells('B1:F1');
            ws3.mergeCells('G1:K1');
            [summaryHeader1, summaryHeader2].forEach(row => {
                row.eachCell(cell => {
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0FFFF' } };
                });
            });
            const gstr2bSummary = calculateSummary(reconciled2bData, false);
            const gstr3bSummary = calculateSummary(reconciled3bData, true);
            const criteria = detailedReconciliationCheckbox.checked ?
                ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'] :
                ['Match', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'];
            criteria.forEach(criterion => {
                ws3.addRow([
                    criterion,
                    gstr2bSummary.summary[criterion].taxable,
                    gstr2bSummary.summary[criterion].igst,
                    gstr2bSummary.summary[criterion].cgst,
                    gstr2bSummary.summary[criterion].sgst,
                    gstr2bSummary.summary[criterion].cess,
                    gstr3bSummary.summary[criterion].taxable,
                    gstr3bSummary.summary[criterion].igst,
                    gstr3bSummary.summary[criterion].cgst,
                    gstr3bSummary.summary[criterion].sgst,
                    gstr3bSummary.summary[criterion].cess
                ]);
            });
            const totalRow = ws3.addRow([
                'Total',
                gstr2bSummary.total.taxable,
                gstr2bSummary.total.igst,
                gstr2bSummary.total.cgst,
                gstr2bSummary.total.sgst,
                gstr2bSummary.total.cess,
                gstr3bSummary.total.taxable,
                gstr3bSummary.total.igst,
                gstr3bSummary.total.cgst,
                gstr3bSummary.total.sgst,
                gstr3bSummary.total.cess
            ]);

            totalRow.eachCell(cell => { cell.font = { bold: true }; });
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const link = document.getElementById('download-output');
            link.href = url;
            link.download = 'Reconciled_GST_Data.xlsx';
            document.getElementById('output-link').style.display = 'block';
        }

        function applyExcelRowColor(row, match, columnCount) {
            const colors = detailedReconciliationCheckbox.checked ? {
                'Match - GSTN, Invoice No., Date': 'FF00CED1',
                'Match - GSTN, Invoice No.': 'FF4B0082',
                'Match - GSTN, Date': 'FF32CD32',
                'Match - GSTN': 'FFFFBF00',
                'Unmatch - GSTN Not Exist': 'FFDC143C',
                'Unmatch - Amt Diff': 'FFFF4500',
                'Unmatch': 'FFFF00FF'
            } : {
                'Match': 'FF00CED1',
                'Unmatch - GSTN Not Exist': 'FFDC143C',
                'Unmatch - Amt Diff': 'FFFF4500',
                'Unmatch': 'FFFF00FF'
            };
            const color = colors[match] || 'FFFF00FF';
            for (let i = 1; i <= columnCount; i++) {
                const cell = row.getCell(i);
                cell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: color }
                };
                if ((detailedReconciliationCheckbox.checked && 
                    ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'].includes(match)) ||
                    (!detailedReconciliationCheckbox.checked && 
                    ['Match', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'].includes(match))) {
                    cell.font = { color: { argb: 'FFFFFFFF' } };
                }
            }
        }

        // Email functionality
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function getFilteredEntries() {
            const entryFilter = document.getElementById('entry-filter').value;
            const filtered = {
                gstr2b: [],
                gstr3b: []
            };

            gstr2bData.forEach(row => {
                const matchCriteria = row[0];
                if (entryFilter === 'all' || 
                    (entryFilter === 'match' && matchCriteria.includes('Match')) ||
                    (entryFilter === 'unmatch' && (matchCriteria.includes('Unmatch') || matchCriteria === 'Unmatch'))) {
                    filtered.gstr2b.push(row);
                }
            });

            gstr3bData.forEach(row => {
                const matchCriteria = row[0];
                if (entryFilter === 'all' || 
                    (entryFilter === 'match' && matchCriteria.includes('Match')) ||
                    (entryFilter === 'unmatch' && (matchCriteria.includes('Unmatch') || matchCriteria === 'Unmatch'))) {
                    filtered.gstr3b.push(row);
                }
            });

            return filtered;
        }

        function formatEntriesAsText(filtered) {
            let body = 'GST Reconciliation Report\n\n';
            body += `Filter: ${document.getElementById('entry-filter').options[document.getElementById('entry-filter').selectedIndex].text}\n\n`;
            
            body += '=== GSTR-2B Entries ===\n';
            if (filtered.gstr2b.length === 0) {
                body += 'No entries found.\n';
            } else {
                body += `Total Entries: ${filtered.gstr2b.length}\n\n`;
                filtered.gstr2b.forEach((row, index) => {
                    body += `Entry ${index + 1}:\n`;
                    body += `Match Status: ${row[0]}\n`;
                    body += `GSTN: ${row[1] || ''}\n`;
                    body += `Supplier: ${row[2] || ''}\n`;
                    body += `Invoice No: ${row[3] || ''}\n`;
                    body += `Date: ${row[5] || ''}\n`;
                    body += `Taxable Value: ${row[10] || 0}\n`;
                    body += `IGST: ${row[11] || 0}\n`;
                    body += `CGST: ${row[12] || 0}\n`;
                    body += `SGST: ${row[13] || 0}\n`;
                    body += `CESS: ${row[14] || 0}\n\n`;
                });
            }
            body += '\n';
            
            body += '=== GSTR-3B Entries ===\n';
            if (filtered.gstr3b.length === 0) {
                body += 'No entries found.\n';
            } else {
                body += `Total Entries: ${filtered.gstr3b.length}\n\n`;
                filtered.gstr3b.forEach((row, index) => {
                    body += `Entry ${index + 1}:\n`;
                    body += `Match Status: ${row[0]}\n`;
                    body += `Date: ${row[1] || ''}\n`;
                    body += `GSTN: ${row[2] || ''}\n`;
                    body += `Supplier: ${row[3] || ''}\n`;
                    body += `Invoice No: ${row[4] || ''}\n`;
                    body += `Taxable Value: ${row[5] || 0}\n`;
                    body += `IGST: ${row[6] || 0}\n`;
                    body += `CGST: ${row[7] || 0}\n`;
                    body += `SGST: ${row[8] || 0}\n`;
                    body += `CESS: ${row[9] || 0}\n\n`;
                });
            }
            return body;
        }

        // Email event listener
        document.getElementById('send-email-btn').addEventListener('click', () => {
            const senderEmail = document.getElementById('sender-email').value.trim();
            const receiverEmail = document.getElementById('receiver-email').value.trim();
            const errorElement = document.getElementById('email-error');

            if (!senderEmail || !receiverEmail) {
                errorElement.textContent = 'Please enter both sender and receiver email addresses.';
                errorElement.classList.remove('hidden');
                return;
            }

            if (!isValidEmail(senderEmail) || !isValidEmail(receiverEmail)) {
                errorElement.textContent = 'Please enter valid email addresses.';
                errorElement.classList.remove('hidden');
                return;
            }

            errorElement.textContent = '';
            errorElement.classList.add('hidden');

            const filtered = getFilteredEntries();
            const emailBody = formatEntriesAsText(filtered);
            const subject = `GST Reconciliation Report - ${document.getElementById('entry-filter').options[document.getElementById('entry-filter').selectedIndex].text}`;

            const mailtoUrl = `mailto:${receiverEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;

            try {
                window.open(mailtoUrl, '_blank');
            } catch (e) {
                errorElement.textContent = 'Failed to open email client. Please check your email client settings.';
                errorElement.classList.remove('hidden');
            }
        });

        // Utility functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Instructions modal
        function showInstructions() {
            document.getElementById("instructions-modal").style.display = "block";
        }

        function hideInstructions() {
            document.getElementById("instructions-modal").style.display = "none";
        }

        window.onclick = function(event) {
            var modal = document.getElementById("instructions-modal");
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // Mobile menu functionality
        document.addEventListener('DOMContentLoaded', function() {
            const menuBtn = document.querySelector('.mobile-menu-btn');
            const container = document.querySelector('.container');
            
            menuBtn.addEventListener('click', function() {
                container.classList.toggle('mobile-menu-open');
            });
            
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.mobile-menu-btn') && !event.target.closest('.nav-links')) {
                    container.classList.remove('mobile-menu-open');
                }
            });
        });
    </script>
</body>
</html>
