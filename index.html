<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GST Reconciliation Tool</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 30px;
            background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
            color: #333;
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #00796b;
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        h2 {
            text-align: center;
            color: #004d40;
            font-size: 1.8em;
            margin: 20px 0;
        }

        .upload-section, .input-section {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            gap: 20px;
        }

        .upload-section div, .input-section div {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        label {
            font-weight: bold;
            color: #00695c;
        }

        input[type="file"], input[type="number"] {
            padding: 10px;
            border: 2px solid #26a69a;
            border-radius: 5px;
            background: #f1f8e9;
            transition: border-color 0.3s;
        }

        input[type="file"]:hover, input[type="number"]:hover {
            border-color: #00796b;
        }

        .data-container {
            margin: 30px 0;
        }

        .table-container {
            overflow-x: auto;
            margin: 10px 0;
            border: 1px solid #b0bec5;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #cfd8dc;
            padding: 12px;
            text-align: left;
        }

        th {
            background: #e0ffff; /* Light Cyan for headings */
            color: #004d40;
            font-weight: bold;
        }

        button {
            display: block;
            margin: 30px auto;
            padding: 12px 30px;
            background: linear-gradient(45deg, #26a69a, #00796b);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        a#download-sample, a#download-output {
            display: block;
            text-align: center;
            margin: 20px auto;
            color: #00796b;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s;
        }

        a#download-sample:hover, a#download-output:hover {
            color: #004d40;
        }

        .match-gstn-inv-date { background-color: #00ced1; color: white; } /* Teal */
        .match-inv { background-color: #4b0082; color: white; } /* Indigo */
        .match-gstn-date { background-color: #32cd32; color: white; } /* Lime Green */
        .match-gstn { background-color: #ffbf00; } /* Amber */
        .gstn-not-match { background-color: #dc143c; color: white; } /* Crimson */
        .no-match { background-color: #ff00ff; color: white; } /* Magenta */

        @media (max-width: 768px) {
            .upload-section, .input-section {
                flex-direction: column;
            }
            .container {
                padding: 20px;
            }
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>GST Reconciliation Tool</h1>
        
        <!-- Download Sample File -->
        <a href="#" id="download-sample">Download Sample Excel File</a>

        <!-- Input for Difference Allowed -->
        <div class="input-section">
            <div>
                <label for="diff-allowed">Difference Allowed (Default: 1):</label>
                <input type="number" id="diff-allowed" value="1" min="0" placeholder="0 if blank">
            </div>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <div>
                <label for="gst-file">Upload GST Data File (GSTR-2B & GSTR-3B):</label>
                <input type="file" id="gst-file" accept=".xlsx">
            </div>
        </div>

        <!-- Data Display -->
        <div class="data-container">
            <h2>GSTR-2B Data</h2>
            <div id="gstr2b-container" class="table-container"></div>
            
            <h2>GSTR-3B Data</h2>
            <div id="gstr3b-container" class="table-container"></div>

            <h2>Summary</h2>
            <div id="summary-container" class="table-container"></div>
        </div>

        <!-- Reconcile Button -->
        <button id="reconcile-btn">Reconcile</button>

        <!-- Output Link -->
        <div id="output-link" style="display: none;">
            <h3>Reconciled Output:</h3>
            <a id="download-output" href="#">Download Reconciled Data</a>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script>
        let gstr2bData = [];
        let gstr3bData = [];

        document.getElementById('gst-file').addEventListener('change', handleFileUpload);
        document.getElementById('reconcile-btn').addEventListener('click', reconcileData);
        document.getElementById('download-sample').addEventListener('click', generateSampleFile);

        function formatDate(excelDate) {
            if (!excelDate) return '';
            const date = new Date((excelDate - 25569) * 86400 * 1000);
            const day = String(date.getUTCDate()).padStart(2, '0');
            const month = date.toUTCString().slice(8, 11);
            const year = date.getUTCFullYear();
            return `${day}-${month}-${year}`;
        }

        // Define headers in a scalable way
        const baseGstr2bHeaders = [
            'Match Criteria', 'GSTN', 'Name of Supplier', 'Invoice Number', 
            'Invoice type', 'Invoice Date', 'Invoice Value', 'Place of supply', 'Reverse Charge', 
            'Rate (%)', 'Taxable Value', 'IGST', 'CGST', 'SGST'
        ];
        const extendedGstr2bHeaders = [
            'Cess', 'GSTR-1/5 Period', 'GSTR-1/5 Filing Date', 'ITC Availability', 
            'Reason', 'Applicable % of Tax Rate', 'Source', 'IRN', 'IRN Date'
        ];
        function gstr2bHeaders() {
            return [...baseGstr2bHeaders, ...extendedGstr2bHeaders];
        }

        const baseGstr3bHeaders = [
            'Match Criteria', 'Invoice Date', 'GSTN', 'Name of Supplier', 
            'Invoice Number', 'Taxable Value', 'IGST', 'CGST', 'SGST'
        ];
        const extendedGstr3bHeaders = ['Invoice Value'];
        function gstr3bHeaders() {
            return [...baseGstr3bHeaders, ...extendedGstr3bHeaders];
        }

        function generateSampleFile(event) {
            event.preventDefault();
            const wb = XLSX.utils.book_new();

            const gstr2bSampleHeaders = gstr2bHeaders();
            const gstr2bSample = [
                gstr2bSampleHeaders,
                ['Match', '27AABCU9603R1ZM', 'Supplier A', 'INV001', 'Regular', '01-Mar-2025', 11800, 'Maharashtra', 'N', 18, 10000, 1800, 0, 0, 0, 'Mar-2025', '15-Mar-2025', 'Yes', 'N/A', 18, 'GSTR-1', 'IRN001', '02-Mar-2025'],
                ['Match', '27AABCU9603R1ZM', 'Supplier A', 'INV002', 'Regular', '01-Mar-2025', 5900, 'Maharashtra', 'N', 18, 5000, 900, 0, 0, 0, 'Mar-2025', '15-Mar-2025', 'Yes', 'N/A', 18, 'GSTR-1', 'IRN002', '02-Mar-2025'],
                ['Match', '27XYZ1234P1ZQ', 'Supplier C', 'INV003', 'Regular', '02-Mar-2025', 23600, 'Karnataka', 'N', 9, 20000, 0, 1800, 1800, 0, 'Mar-2025', '16-Mar-2025', 'No', 'Pending', 9, 'GSTR-5', 'IRN003', '03-Mar-2025']
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(gstr2bSample);
            gstr2bSampleHeaders.forEach((_, index) => {
                const cell = ws1[XLSX.utils.encode_cell({ r: 0, c: index })];
                if (cell) {
                    cell.s = { fill: { fgColor: { rgb: 'E0FFFF' } } }; // Light Cyan
                }
            });
            XLSX.utils.book_append_sheet(wb, ws1, 'GST Portal');

            const gstr3bSampleHeaders = gstr3bHeaders();
            const gstr3bSample = [
                gstr3bSampleHeaders,
                ['Match', '01-Mar-2025', '27AABCU9603R1ZM', 'Supplier A', 'INV001', 10002, 1802, 0, 0, 11806], // Changed to test 2 Rs difference
                ['Match', '02-Mar-2025', '27AABCU9603R1ZM', 'Supplier A', 'INV004', 6000, 1080, 0, 0, 7080]
            ];
            const ws2 = XLSX.utils.aoa_to_sheet(gstr3bSample);
            gstr3bSampleHeaders.forEach((_, index) => {
                const cell = ws2[XLSX.utils.encode_cell({ r: 0, c: index })];
                if (cell) {
                    cell.s = { fill: { fgColor: { rgb: 'E0FFFF' } } }; // Light Cyan
                }
            });
            XLSX.utils.book_append_sheet(wb, ws2, 'Client Data');

            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'Sample_GST_Reconciliation.xlsx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function normalizeRow(row, headerLength) {
            const normalized = new Array(headerLength).fill('');
            row.forEach((cell, index) => {
                if (index < headerLength) {
                    normalized[index] = cell === undefined || cell === null ? '' : cell;
                }
            });
            return normalized;
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', dateNF: 'dd-mmm-yyyy' });

                const gstr2bSheet = workbook.Sheets['GST Portal'];
                if (gstr2bSheet) {
                    const rawData = XLSX.utils.sheet_to_json(gstr2bSheet, { header: 1, raw: true, defval: '' });
                    gstr2bData = rawData.slice(1).map(row => normalizeRow(row, gstr2bHeaders().length));
                    displayData(gstr2bData, 'gstr2b-container', gstr2bHeaders());
                }

                const gstr3bSheet = workbook.Sheets['Client Data'];
                if (gstr3bSheet) {
                    const rawData = XLSX.utils.sheet_to_json(gstr3bSheet, { header: 1, raw: true, defval: '' });
                    gstr3bData = rawData.slice(1).map(row => normalizeRow(row, gstr3bHeaders().length));
                    displayData(gstr3bData, 'gstr3b-container', gstr3bHeaders());
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function displayData(data, containerId, headers) {
            const container = document.getElementById(containerId);
            let html = '<table><thead><tr>';
            headers.forEach(header => html += `<th>${header}</th>`);
            html += '</tr></thead><tbody>';
            data.forEach(row => {
                html += '<tr>';
                headers.forEach((_, index) => {
                    const cell = row[index];
                    const value = typeof cell === 'number' && (cell > 40000 && cell < 50000) ? formatDate(cell) : (cell === undefined || cell === null ? '' : cell);
                    html += `<td${index === 0 ? ' class="match-criteria"' : ''}>${value}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function reconcileData() {
            const diffInput = document.getElementById('diff-allowed').value;
            const diffAllowed = diffInput === '' ? 0 : Number(diffInput) || 1; // Default to 1, blank means 0
            const gstr2bTable = document.querySelector('#gstr2b-container table tbody');
            const gstr3bTable = document.querySelector('#gstr3b-container table tbody');
            const reconciled2bData = [];
            const reconciled3bData = [];

            // Reconcile GSTR-2B
            gstr2bData.forEach((row, index) => {
                const match = findMatch(row, gstr2bData, gstr3bData, false, diffAllowed);
                const newRow = [match, ...row.slice(1)];
                reconciled2bData.push(newRow);
                updateRow(gstr2bTable.rows[index], newRow);
            });

            // Reconcile GSTR-3B
            gstr3bData.forEach((row, index) => {
                const match = findMatch(row, gstr3bData, gstr2bData, true, diffAllowed);
                const newRow = [match, ...row.slice(1)];
                reconciled3bData.push(newRow);
                updateRow(gstr3bTable.rows[index], newRow);
            });

            displaySummary(reconciled2bData, reconciled3bData);
            generateOutput(reconciled2bData, reconciled3bData);
        }

        function updateRow(rowElement, newRow) {
            const match = newRow[0];
            rowElement.cells[0].textContent = match;
            colorRow(rowElement, match);
        }

        function findMatch(row, sourceData, compareData, is3b, diffAllowed) {
    const sourceHeaders = is3b ? gstr3bHeaders() : gstr2bHeaders();
    const compareHeaders = is3b ? gstr2bHeaders() : gstr3bHeaders();
    const invDateIdx = sourceHeaders.indexOf('Invoice Date');
    const gstnIdx = sourceHeaders.indexOf('GSTN');
    const invNumIdx = sourceHeaders.indexOf('Invoice Number');
    const compareGstnIdx = compareHeaders.indexOf('GSTN'); // Compare sheet ke liye correct GSTN index

    const [invDate, gstn, invNum] = [row[invDateIdx], row[gstnIdx], row[invNumIdx]];

    // Step 1: GSTN, Invoice Number, Date check
    const sourceTotals = calculateTotals(sourceData, invDate, gstn, invNum, is3b);
    const compareTotals = calculateTotals(compareData, invDate, gstn, invNum, !is3b);
    if (sourceTotals.count > 0 && compareTotals.count > 0) {
        if (checkTotals(sourceTotals, compareTotals, diffAllowed)) {
            return 'GSTN, Invoice No. & Date';
        }
    }

    // Step 2-4: Dusre criteria checks (Invoice Number, GSTN & Date, GSTN only)
    // (Inhe bhi check kiya jata hai, lekin aapke case mein yeh fail honge kyunki diff > diffAllowed)

    // Step 5: GSTN-Not Match check
    const gstnExistsInCompare = compareData.some(r => r[compareGstnIdx] === gstn);
    if (!gstnExistsInCompare) {
        return 'GSTN-Not Match';
    }

    // Step 6: Default
    return 'Not match any creteria';
}
        function calculateTotals(data, invDate, gstn, invNum, is3b) {
            const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
            const invDateIdx = headers.indexOf('Invoice Date');
            const gstnIdx = headers.indexOf('GSTN');
            const invNumIdx = headers.indexOf('Invoice Number');
            const taxableIdx = headers.indexOf('Taxable Value');
            const igstIdx = headers.indexOf('IGST');
            const cgstIdx = headers.indexOf('CGST');
            const sgstIdx = headers.indexOf('SGST');

            const filtered = data.filter(r => 
                r[invDateIdx] === invDate && r[gstnIdx] === gstn && r[invNumIdx] === invNum
            );
            return sumValues(filtered, taxableIdx, igstIdx, cgstIdx, sgstIdx);
        }

        function calculateTotalsByInv(data, gstn, invNum, is3b) {
            const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
            const gstnIdx = headers.indexOf('GSTN');
            const invNumIdx = headers.indexOf('Invoice Number');
            const taxableIdx = headers.indexOf('Taxable Value');
            const igstIdx = headers.indexOf('IGST');
            const cgstIdx = headers.indexOf('CGST');
            const sgstIdx = headers.indexOf('SGST');

            const filtered = data.filter(r => r[gstnIdx] === gstn && r[invNumIdx] === invNum);
            return sumValues(filtered, taxableIdx, igstIdx, cgstIdx, sgstIdx);
        }

        function calculateTotalsByGstnDate(data, invDate, gstn, is3b) {
            const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
            const invDateIdx = headers.indexOf('Invoice Date');
            const gstnIdx = headers.indexOf('GSTN');
            const taxableIdx = headers.indexOf('Taxable Value');
            const igstIdx = headers.indexOf('IGST');
            const cgstIdx = headers.indexOf('CGST');
            const sgstIdx = headers.indexOf('SGST');

            const filtered = data.filter(r => r[invDateIdx] === invDate && r[gstnIdx] === gstn);
            return sumValues(filtered, taxableIdx, igstIdx, cgstIdx, sgstIdx);
        }

        function calculateTotalsByGstn(data, gstn, is3b) {
            const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
            const gstnIdx = headers.indexOf('GSTN');
            const taxableIdx = headers.indexOf('Taxable Value');
            const igstIdx = headers.indexOf('IGST');
            const cgstIdx = headers.indexOf('CGST');
            const sgstIdx = headers.indexOf('SGST');

            const filtered = data.filter(r => r[gstnIdx] === gstn);
            return sumValues(filtered, taxableIdx, igstIdx, cgstIdx, sgstIdx);
        }

        function sumValues(rows, taxableIdx, igstIdx, cgstIdx, sgstIdx) {
            let taxable = 0, igst = 0, cgst = 0, sgst = 0, count = 0;
            rows.forEach(row => {
                taxable += Number(row[taxableIdx]) || 0;
                igst += Number(row[igstIdx]) || 0;
                cgst += Number(row[cgstIdx]) || 0;
                sgst += Number(row[sgstIdx]) || 0;
                count++;
            });
            return { taxable, igst, cgst, sgst, count };
        }

        function checkTotals(sourceTotals, compareTotals, diffAllowed) {
            return Math.abs(sourceTotals.taxable - compareTotals.taxable) <= diffAllowed &&
                   Math.abs(sourceTotals.igst - compareTotals.igst) <= diffAllowed &&
                   Math.abs(sourceTotals.cgst - compareTotals.cgst) <= diffAllowed &&
                   Math.abs(sourceTotals.sgst - compareTotals.sgst) <= diffAllowed;
        }

        function colorRow(row, match) {
            row.className = '';
            switch (match) {
                case 'GSTN, Invoice No. & Date': row.classList.add('match-gstn-inv-date'); break;
                case 'Invoice Number': row.classList.add('match-inv'); break;
                case 'GSTN & Date': row.classList.add('match-gstn-date'); break;
                case 'GSTN': row.classList.add('match-gstn'); break;
                case 'GSTN-Not Match': row.classList.add('gstn-not-match'); break;
                default: row.classList.add('no-match'); break;
            }
        }

        function calculateSummary(data, is3b) {
            const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
            const taxableIdx = headers.indexOf('Taxable Value');
            const igstIdx = headers.indexOf('IGST');
            const cgstIdx = headers.indexOf('CGST');
            const sgstIdx = headers.indexOf('SGST');

            const criteria = [
                'GSTN, Invoice No. & Date',
                'Invoice Number',
                'GSTN & Date',
                'GSTN',
                'GSTN-Not Match',
                'Not match any creteria'
            ];

            const summary = {};
            criteria.forEach(criterion => {
                summary[criterion] = { taxable: 0, igst: 0, cgst: 0, sgst: 0 };
            });

            data.forEach(row => {
                const match = row[0];
                summary[match].taxable += Number(row[taxableIdx]) || 0;
                summary[match].igst += Number(row[igstIdx]) || 0;
                summary[match].cgst += Number(row[cgstIdx]) || 0;
                summary[match].sgst += Number(row[sgstIdx]) || 0;
            });

            const total = { taxable: 0, igst: 0, cgst: 0, sgst: 0 };
            criteria.forEach(criterion => {
                total.taxable += summary[criterion].taxable;
                total.igst += summary[criterion].igst;
                total.cgst += summary[criterion].cgst;
                total.sgst += summary[criterion].sgst;
            });

            return { summary, total };
        }

        function displaySummary(reconciled2bData, reconciled3bData) {
            const gstr2bSummary = calculateSummary(reconciled2bData, false);
            const gstr3bSummary = calculateSummary(reconciled3bData, true);
            const container = document.getElementById('summary-container');

            let html = '<table><thead><tr>';
            html += '<th rowspan="2">Particulars</th>';
            html += '<th colspan="4">GST Portal</th>';
            html += '<th colspan="4">Client Data</th>';
            html += '</tr><tr>';
            ['Taxable Value', 'IGST', 'CGST', 'SGST'].forEach(header => {
                html += `<th>${header}</th>`;
            });
            ['Taxable Value', 'IGST', 'CGST', 'SGST'].forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';

            const criteria = [
                'GSTN, Invoice No. & Date',
                'Invoice Number',
                'GSTN & Date',
                'GSTN',
                'GSTN-Not Match',
                'Not match any creteria'
            ];

            criteria.forEach(criterion => {
                html += '<tr>';
                html += `<td>${criterion}</td>`;
                html += `<td>${gstr2bSummary.summary[criterion].taxable.toFixed(2)}</td>`;
                html += `<td>${gstr2bSummary.summary[criterion].igst.toFixed(2)}</td>`;
                html += `<td>${gstr2bSummary.summary[criterion].cgst.toFixed(2)}</td>`;
                html += `<td>${gstr2bSummary.summary[criterion].sgst.toFixed(2)}</td>`;
                html += `<td>${gstr3bSummary.summary[criterion].taxable.toFixed(2)}</td>`;
                html += `<td>${gstr3bSummary.summary[criterion].igst.toFixed(2)}</td>`;
                html += `<td>${gstr3bSummary.summary[criterion].cgst.toFixed(2)}</td>`;
                html += `<td>${gstr3bSummary.summary[criterion].sgst.toFixed(2)}</td>`;
                html += '</tr>';
            });

            html += '<tr>';
            html += '<td><strong>Total</strong></td>';
            html += `<td><strong>${gstr2bSummary.total.taxable.toFixed(2)}</strong></td>`;
            html += `<td><strong>${gstr2bSummary.total.igst.toFixed(2)}</strong></td>`;
            html += `<td><strong>${gstr2bSummary.total.cgst.toFixed(2)}</strong></td>`;
            html += `<td><strong>${gstr2bSummary.total.sgst.toFixed(2)}</strong></td>`;
            html += `<td><strong>${gstr3bSummary.total.taxable.toFixed(2)}</strong></td>`;
            html += `<td><strong>${gstr3bSummary.total.igst.toFixed(2)}</strong></td>`;
            html += `<td><strong>${gstr3bSummary.total.cgst.toFixed(2)}</strong></td>`;
            html += `<td><strong>${gstr3bSummary.total.sgst.toFixed(2)}</strong></td>`;
            html += '</tr>';

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function generateOutput(reconciled2bData, reconciled3bData) {
            const workbook = new ExcelJS.Workbook();

            // GST Portal Sheet
            const ws1 = workbook.addWorksheet('GST Portal');
            const headerRow1 = ws1.addRow(gstr2bHeaders());
            headerRow1.eachCell(cell => {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0FFFF' } }; // Light Cyan
            });
            reconciled2bData.forEach(row => {
                const excelRow = row.map(cell => cell === undefined || cell === null ? '' : cell);
                const addedRow = ws1.addRow(excelRow);
                applyExcelRowColor(addedRow, row[0], gstr2bHeaders().length);
            });

            // Client Data Sheet
            const ws2 = workbook.addWorksheet('Client Data');
            const headerRow2 = ws2.addRow(gstr3bHeaders());
            headerRow2.eachCell(cell => {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0FFFF' } }; // Light Cyan
            });
            reconciled3bData.forEach(row => {
                const excelRow = row.map(cell => cell === undefined || cell === null ? '' : cell);
                const addedRow = ws2.addRow(excelRow);
                applyExcelRowColor(addedRow, row[0], gstr3bHeaders().length);
            });

            // Summary Sheet
            const ws3 = workbook.addWorksheet('Summary');
            const summaryHeader1 = ws3.addRow(['Particulars', 'GST Portal', '', '', '', 'Client Data', '', '', '']);
            const summaryHeader2 = ws3.addRow(['', 'Taxable Value', 'IGST', 'CGST', 'SGST', 'Taxable Value', 'IGST', 'CGST', 'SGST']);
            ws3.mergeCells('A1:A2');
            ws3.mergeCells('B1:E1');
            ws3.mergeCells('F1:I1');
            [summaryHeader1, summaryHeader2].forEach(row => {
                row.eachCell(cell => {
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0FFFF' } }; // Light Cyan
                });
            });

            const gstr2bSummary = calculateSummary(reconciled2bData, false);
            const gstr3bSummary = calculateSummary(reconciled3bData, true);
            const criteria = [
                'GSTN, Invoice No. & Date',
                'Invoice Number',
                'GSTN & Date',
                'GSTN',
                'GSTN-Not Match',
                'Not match any creteria'
            ];

            criteria.forEach((criterion, index) => {
                ws3.addRow([
                    criterion,
                    gstr2bSummary.summary[criterion].taxable,
                    gstr2bSummary.summary[criterion].igst,
                    gstr2bSummary.summary[criterion].cgst,
                    gstr2bSummary.summary[criterion].sgst,
                    gstr3bSummary.summary[criterion].taxable,
                    gstr3bSummary.summary[criterion].igst,
                    gstr3bSummary.summary[criterion].cgst,
                    gstr3bSummary.summary[criterion].sgst
                ]);
            });

            const totalRow = ws3.addRow([
                'Total',
                gstr2bSummary.total.taxable,
                gstr2bSummary.total.igst,
                gstr2bSummary.total.cgst,
                gstr2bSummary.total.sgst,
                gstr3bSummary.total.taxable,
                gstr3bSummary.total.igst,
                gstr3bSummary.total.cgst,
                gstr3bSummary.total.sgst
            ]);
            totalRow.eachCell(cell => {
                cell.font = { bold: true };
            });

            // Generate and download
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const link = document.getElementById('download-output');
            link.href = url;
            link.download = 'Reconciled_GST_Data.xlsx';
            document.getElementById('output-link').style.display = 'block';
        }

        function applyExcelRowColor(row, match, columnCount) {
            const colors = {
                'GSTN, Invoice No. & Date': 'FF00CED1', // Teal #00ced1
                'Invoice Number': 'FF4B0082',          // Indigo #4b0082
                'GSTN & Date': 'FF32CD32',             // Lime Green #32cd32
                'GSTN': 'FFFFBF00',                    // Amber #ffbf00
                'GSTN-Not Match': 'FFDC143C',          // Crimson #dc143c
                'Not match any creteria': 'FFFF00FF'   // Magenta #ff00ff
            };
            const color = colors[match] || 'FFFF00FF'; // Default to Magenta
            for (let i = 1; i <= columnCount; i++) {
                const cell = row.getCell(i);
                cell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: color }
                };
                if (['GSTN, Invoice No. & Date', 'Invoice Number', 'GSTN & Date', 'GSTN-Not Match', 'Not match any creteria'].includes(match)) {
                    cell.font = { color: { argb: 'FFFFFFFF' } }; // White text for dark backgrounds
                }
            }
        }
    </script>
</body>
</html>
